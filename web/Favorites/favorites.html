<html xmlns:msntv>
<?import namespace="msntv" implementation="../HTC/CustomButton.htc">
<?import namespace="msntv" implementation="../HTC/panelheading.htc">
<head>
<meta http-equiv="Content-Language" content="en-us">

<title>Favorites Panel</title>

<link rel=StyleSheet type="text/css" href="../CSS/Default.css">
<link rel=StyleSheet type="text/css" href="../CSS/Panel.css">
<style>
.subHeader
{
	font-size:18px;
	font-family:Highway;
	color:1D1D1D;
 	width:440px;
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
}
.subHeaderTitle
{
	font-size:18px;
	font-family:Highway;
	color:#1D1D1D;
}
.titleContent
{
	font-size:18px;
	font-family:Highway;
	color:#14224B;
	width:250px;
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
}
.hrefContent
{
	font-size:16px;
	font-family:Highway;
	color:#27386D;
	width:250px;
	height:50px;
	overflow: hidden;
	text-overflow: ellipsis;
	word-wrap:break-word;
}
.addFavFolderTitleContent
{
	font-size:18px;
	font-family:Highway;
	color:#010C3E;
	width:310px;
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
}
.addFavTitleContent
{
	font-size:18px;
	font-family:Highway;
	font-weight:bold;
	color:#1D1D1D;
	width:250px;
	height:60px;
	overflow: hidden;
	text-overflow: ellipsis;
	word-wrap:break-word;
}
.addFavHrefContent
{
	font-size:16px;
	font-family:Highway;
	color:#1D1D1D;
	width:350px;
	height:18px;
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
}
.editHrefContent
{
	font-size:16px;
	font-family:Highway;
	color:#27386D;
	width:350px;
	height:50px;
	overflow: hidden;
	text-overflow: ellipsis;
	word-wrap:break-word;
}</style>
<script language="Javascript" src="../Javascript/TVShell.js"></script>
<script language="Javascript" src="../Javascript/PanelImpl.js"></script>
<script language="Javascript" src="../Javascript/ContentPaneHelp.js"></script>
<script language="Javascript" src="../Javascript/Favorites.js"></script>
<script language="Javascript">

var	NumOfShortcuts = 3;
var	animationTimeOut = 4000;
var	PictureBKColor = '#B3E1D8';

var thisPanel = PanelManager.Item("favoritespanel");
var mainPanel = PanelManager.Item("main");
var Sink = new ActiveXObject("MSNTV.MultipleEventSink");


var navigateID =""; // the ID of navigate favorite 
var paramsArray = null;
 var b_ActionDone = false;
var	g_fPending=false;
var	g_pendingURL="";
var MAX_RECENT_THUMBNAILS=100;
var g_backFunc=null;
var g_NeedReload=false;
var g_prevFolderID=null;
var MAX_TITLE_LEN = 242;
var MAX_URL_LEN = 2048;

//--------------------------------------------------------------
// General utilities
//--------------------------------------------------------------

// Removes leading and trailing blanks
function ltrim(strValue) 
{
	var i = 0;
	while (strValue.charAt(i) == ' ') 
	{
		i++;
	}
	return strValue.slice(i);
}

function rtrim(strValue) 
{
	var i = strValue.length - 1;
	while (strValue.charAt(i) == ' ') 
	{
		i--;
	}
	return strValue.slice(0, i + 1);
}

function removeUnusedSpace(strValue) 
{
	if(typeof(strValue) == "undefined" || strValue=="")
	{
		return("");
	}
	return ltrim(rtrim(strValue));
}


// strip folder/favorite name of leading/trailing spaces
// add any other stripping here
// called for rename and add folder
// return empty string for invalid name
function cleanName( s )
{
	var str = removeUnusedSpace( s );
	return str;
}

// Escape backslashes and single quotes
function escapeString(sIn)
{
	var sResult = '';
	if (null != sIn && '' != sIn)
	{
		sResult = sIn.replace(/\\/g, "\\\\");
		sResult = sResult.replace(/\'/g, "\\'");	// "
	}
	return sResult;
}


function ValidateName(str, isFolder)
{
	var isValid = !/[\;\/\\\:\*\?\"\<\>\|]/.test(str);       //"
		
	var msg = (isFolder == false)? "<p>Favorite" : "<p>Folder";

	if ( !isValid ){
		msg += " name cannot contain the following symbols:</p><p><em>\\ /:;* \" \< \>|?</em></p><p>Please try again.</p>";
	}
	else if (str.charAt(0)=="."){
		isValid = false;
		msg += " name cannot start with a </p><p><em>\".\" (period)</em></p><p>Please try again.</p>";
	} else if ( isFolder  &&  /.*\.$/.test(str))
	{
		isValid = false;
		msg += " name cannot end with a </p><p><em>\".\" (period)</em></p><p>Please try again.</p>";
	}

	if ( ! isValid )
	{
		TVShell.PanelManager.CustomMessageBox(msg,"", "OK", 0,"", false, MGX_ICON_WARNING, MGX_SIZE_SMALL);
	}
	
	return isValid;
}



// utility function - given a query string, return and array of name value pairs
function buildParams()
{
	// this determines the ID of the XML node to render favorites
	// from.  node is found eslewhere using selectSingleNode with an
	// escaped version of this id string.
	var url = thisPanel.URL;
	var sSearch = url.indexOf("?") > 0 ? url.substr(url.indexOf("?")) : null;
	var aValues = new Array();
	if (sSearch) 
	{
		sSearch = sSearch.substr(1, sSearch.length);
		var aPairs = sSearch.split("&");
		var aPair = null;

		for (i in aPairs) 
		{
			aPair = aPairs[i].split("=");
			var sName = unescape(aPair[0]);
			var sValue = unescape(aPair[1]);
			var i=2;
			while(sName=="folder" && i< aPair.length){
				sValue +='=';
				sValue += aPair[i++];
			}
			aValues[sName] = sValue;
		}
	}
	return aValues;
}

function removeTags(plainText)
{
	if (plainText == "" || plainText == null)
		return "";
   return TVShell.Utilities.EscapeHTML(plainText);
}

// find the xml node to start rendering from - passed in via the query string
function findCurrentNode()
{
	// Set the current node to the root 
	var currentNode = g_oFavXml.selectSingleNode("/favorites");
	// Try to find the current node from the (non-empty) query string
	// If we have a folder id, set the start node to that node
	var sFolderID = paramsArray["folder"];
	if (null != sFolderID && "" != sFolderID){
		currentNode = g_oFavXml.selectSingleNode("/favorites//favfolder[@id = '" + escapeString(sFolderID) + "']");
	
		// If for some reason, we're passed an invalid folder id, go to the root
		// TODO: Should we just redirect to the entry page, so that the url is correct?
		if (null == currentNode){
			currentNode = g_oFavXml.selectSingleNode("/favorites");
		}
	}
	return currentNode;
}

////////////////////////////////////////////////////////////////////////////////////////
// Set global variable for callRename and callCreateFolder
var L_NEWFOLDERNAME_TEXT = "Unnamed Folder";
var L_NEWFAVORITENAME_TEXT = "Unnamed Favorite";
var MaxNumOfFavorites =1000;

function getDocumentTitle()
{
	var title = L_NEWFAVORITENAME_TEXT;
	var targetPanel=mainPanel;
	var popup=TVShell.PanelManager.Item("popuppanel");
	if(popup && popup.State==0)
         targetPanel=popup;
	if (targetPanel.Document.title != ""){
		title = targetPanel.Document.title.replace(/[\/|\\|:|*|?|\"|\<|\>|\|]/g,"-"); //"
		if ( title.length > MAX_TITLE_LEN )
			title = title.substr(0, MAX_TITLE_LEN);
	}

	return title;
}

function GetTargetPanelURL()
{
	var docFileURL = "";
	if(IsMainPanelInDocViewer())
		docFileURL = thisPanel.UserStrData;
	var theURL = (docFileURL!="") ? docFileURL : mainPanel.URL;

	var popup=TVShell.PanelManager.Item("popuppanel");
	if(popup && popup.State==0)
	   theURL=popup.Document.URL;

	if ( theURL.length > MAX_URL_LEN )
		theURL = theURL.substr(0, MAX_URL_LEN);
	return theURL;
}

function searchFavorites( nodeList, name, isFolder )
{
	if ( nodeList == null || name == null || name == "" )
		return null;

	var nodeListLen = nodeList.length;
	var lowerCaseName = name.toLowerCase();
	for (var i=0; i < nodeListLen; i++) {
		var xmlFavorite = nodeList.item(i);
		if(!isFolder && xmlFavorite && cleanFavoriteName(xmlFavorite.selectSingleNode("title").text.toLowerCase()) == lowerCaseName)
			return xmlFavorite;
		else
			if ( isFolder && xmlFavorite && xmlFavorite.getAttribute("title").toLowerCase() == lowerCaseName )
				return xmlFavorite;
	}

	return null;	
}



function callCreateFavorite(index)//0: add to root; 1: add to a folder; -1: add to a new folder
{
	TVShell.Message("TotalFavoritesCount="+TVShell.UserManager.TotalFavoritesCount + "  CurrentUser Favorites=" + TVShell.UserManager.CurrentUser.FavoritesCount);
	var numOfAvailableFavorites=MaxNumOfFavorites-TVShell.UserManager.CurrentUser.FavoritesCount;
	if (numOfAvailableFavorites < 10) {
		if (numOfAvailableFavorites <= 0) {
			TVShell.PanelManager.CustomMessageBox("Sorry, you don’t have room for any more favorites. Please remove <b>"+(Math.abs(numOfAvailableFavorites)+1) + "</b> or more of your favorites and try again.","", "OK", 0,"",false, MGX_ICON_WARNING, MGX_SIZE_SMALL);
			return null;
		} else {
			if (numOfAvailableFavorites == 1)
				TVShell.PanelManager.CustomMessageBox("After we add this favorite, your list will be full. To add more, remove some of the favorites you don’t use.","", "OK", 0,"",false, MGX_ICON_WARNING, MGX_SIZE_SMALL);
			else if (numOfAvailableFavorites == 2)	/* 2 because we're just about to add one */
				TVShell.PanelManager.CustomMessageBox("You have room for one more favorite.","", "OK", 0,"",false, MGX_ICON_WARNING, MGX_SIZE_SMALL);
			else
				TVShell.PanelManager.CustomMessageBox("You have room for at most " + (numOfAvailableFavorites-1) + " more favorites.","", "OK", 0,"",false, MGX_ICON_WARNING, MGX_SIZE_SMALL);
		}
	}
	var sFavoriteNameBase = getDocumentTitle();
	if ( document.all.addFavTitle)
		sFavoriteNameBase = document.all.addFavTitle.value;	

	var sFavoriteName;
	var pcwszUrl = GetTargetPanelURL();
	if ( document.all.addFavURL)
		pcwszUrl = document.all.addFavURL.value;
	
	var pcwszThumbNailUrl = GetCurrentThumbnailURL();

	var oNode=null;
	if (index == 0) {
		oNode = g_oFavXml.selectSingleNode("/favorites");
	} else if(index == -1){
		var folderID = callCreateFolder();
		if(folderID != null){
		    oNode = g_oFavXml.selectSingleNode("//favfolder[@id = '" + escapeString(folderID) + "']"); 
		}
	} else {
		var folderList = g_oFavXml.selectNodes("//favorites/favfolder");   // all folder nodes
		if (index <= folderList.length) {
			oNode = folderList.item(index-1); 
		}
	}
	sFavoriteName = cleanName(sFavoriteNameBase);

    if (oNode) {	
		var xmlFavoriteList = oNode.selectNodes("favorite");

		var dupNode = searchFavorites( xmlFavoriteList, sFavoriteName, false );
		if ( dupNode )
		{
			// There's an existing favorite with this name
			TVShell.PanelManager.CustomMessageBox( "<p>A favorite with that name already exists.</p>Please choose a different name." ,"", "OK", 0,"",	 false,MGX_ICON_WARNING, MGX_SIZE_SMALL);
			return null;
		}

		return AddFavorite(oNode, sFavoriteName, pcwszUrl, pcwszThumbNailUrl);
			
    } 

	return null;
	
}

var AddedFolderName = "";
// look for the first available "New Folder (#)" and create it
function callCreateFolder()
{
	var numOfAvailableFavorites=MaxNumOfFavorites-TVShell.UserManager.CurrentUser.FavoritesCount;
	if (numOfAvailableFavorites <= 0) {
		TVShell.PanelManager.CustomMessageBox("Sorry, you don’t have room for any more folders. Please remove <b>"+(Math.abs(numOfAvailableFavorites)+1) + "</b> or more of your folders or favorites and try again.","", "OK", 0,"",false, MGX_ICON_WARNING, MGX_SIZE_SMALL);
		return null;
	}
	
//  var oNode = findCurrentNode();
	var oNode =g_oFavXml.selectSingleNode("/favorites");
    var sFolderNameBase = L_NEWFOLDERNAME_TEXT;
	var name = cleanName( document.all.folderTitleText.value );
 	if(name !=""){
		if ( ValidateName( name, true ) )
			sFolderNameBase = name;
		else
			return null;
 	}
	else
	{
		document.all.folderTitleText.value = sFolderNameBase;
		TVShell.PanelManager.CustomMessageBox("<P>You must enter a folder name.</P>","", "OK", 0,"", false, MGX_ICON_WARNING, MGX_SIZE_SMALL);
		return null;
	}
    var sFolderName = sFolderNameBase;

	var folderList = oNode.selectNodes("favfolder");
	var dupNode = searchFavorites( folderList, sFolderName, true);
	if ( dupNode ){
		document.all.folderTitleText.value = sFolderName;
		TVShell.PanelManager.CustomMessageBox("<P>A folder with that name already exists.</P>Please choose a different name.","", "OK", 0,"", false, MGX_ICON_WARNING, MGX_SIZE_SMALL);
		return null;		
	}

	if (oNode) 
	{
		AddedFolderName = sFolderName;
		return AddFavoriteFolder(oNode, sFolderName);
	}

	return null;  
}



// call delete method on xml source object
function callDelete()
{
	var oCurrentNode=findCurrentNode();
	var xmlFavFolderList= oCurrentNode.selectNodes("favfolder");
	var favFolderListLen=hasFolder(xmlFavFolderList.length);
	var xmlFavoriteList= oCurrentNode.selectNodes("favorite");
	var favoriteListLen= xmlFavoriteList.length;
	var delOK=0;	// 0: good and jump to organize;   1:  bad and jump to organize;  2: bad and stay @ current page
	numOfDeletedFav = 0;
	numOfDeletedFolder = 0;
	var numFoldersToDelete = 0;
	var numFoldersToDeleteWithContent = 0;

	var delFavArray = new Array();
	var idx=0;

	var inputs = document.all.tags("input");
	for (var i = favFolderListLen-1; i >= 0; i--)
	{
		if(inputs[i+favoriteListLen].checked == true)
		{
			numFoldersToDelete++;
			var xmlFavFolder = xmlFavFolderList.item(i);
			if(xmlFavFolder.selectNodes("favorite").length > 0)
			{
				numFoldersToDeleteWithContent++;
			}
			delFavArray[idx++] = xmlFavFolder;
		}
	}

	// display a warning if a folder contains favorites
	if ( numFoldersToDeleteWithContent > 0 )
	{
		var str;
		var butStr;
		if ( numFoldersToDelete == 1 )	// deleting one folder and it contains content
		{
			str = "<P>You have chosen to delete a folder that contains favorites.  Deleting this folder will also delete all of the favorites in it.</P>"; 
			str += "<P>Do you want to delete this folder?</P>";
			butStr = "Do not Delete Folder;Delete Folder";
		}
		else
		{
			str = "<P>You have chosen to delete folders.  One or more of these folders contain favorites.  Deleting folders will also delete all of the favorites in them.</P>"; 
			str += "<P>Do you want to delete these folders?</P>";
			butStr = "Do not Delete Folders;Delete Folders";
		}
		var result =  TVShell.PanelManager.CustomMessageBox(str, "" , butStr , 1,"", 1, MGX_ICON_WARNING, MGX_SIZE_LARGE);
		if (result == 0)	return 1;
	}

	var favXmlStr="";
	for (var i = favoriteListLen-1; i >= 0; i--) {
		if(inputs[i].checked == true) {
			delFavArray[idx++] = xmlFavoriteList.item(i);;
			numOfDeletedFav ++;
		}
	}

	numOfDeletedFolder = numFoldersToDelete;
	
	if (numOfDeletedFav == 0 && numOfDeletedFolder == 0) {
		TVShell.PanelManager.CustomMessageBox("Please select a favorite or a folder to delete.","", "OK", 0,"", 1, MGX_ICON_WARNING, MGX_SIZE_SMALL);
		return 2;
	}

	for ( var j=0; j < idx; j++ )
	{
		delOK = DeleteFavorite( delFavArray[j]);
		if ( delOK != 0 ){
			// something was wrong, stop the delete process.
			var msgStr;
			if ( j == 0 ){
				msgStr = "<p>Your request cannot be completed at this time.</p><p>Please try again later.</p>";
			}
			else{
				msgStr = "<p>One or more of your favorite or folder were not able to delete.</p><Please try again later.</p>";
			}
			TVShell.PanelManager.CustomMessageBox(msgStr,"", "OK", 0,"", 1, MGX_ICON_WARNING, MGX_SIZE_SMALL);
			
			break;
		}
	}
	
	delete delFavArray;
	delFavArray = null;
	
	return delOK;
}









function callMoveToFolder() 
{	
	var parentFolder = findCurrentNode();           
    var folderList = g_oFavXml.selectNodes("//favorites/favfolder");   // all folder nodes
    var folderListLen = folderList.length; 
	var specialLen = 1;//new folder
	var index = -1;
	var cnt = -1;
	var inputs = document.all.tags("input");
	for (var i = 0; i < inputs.length && index == -1; i++) {
		if (inputs[i].checked == true)
			index = i;
	}
//	TVShell.Message("index="+index + " folderListLen="+folderListLen + "numOfMovedFav="+numOfMovedFav);
	var folder=null;
	if (index == folderListLen + specialLen - 1) {
		var folderID = callCreateFolder();
		if (folderID != null) {
		    folder = g_oFavXml.selectSingleNode("//favfolder[@id = '" + escapeString(folderID) + "']"); 
		}
	} else if (parentFolder.nodeName != "favorites" && index == 0) {
		folder = g_oFavXml.selectSingleNode("/favorites");  // root node
	} else {
		if(parentFolder.nodeName != "favorites") {
			var num = -1;
			for (var i = 0; i < folderListLen && num == -1; i++) {
				var tempFolder = folderList.item(i);
				if (tempFolder.getAttribute("id") == parentFolder.getAttribute("id")) 
					num = i;
			}
			TVShell.Message(" index= "+index + " num= " + num);
			if (index <= num)
				folder = folderList.item(index-1);
			else
				folder = folderList.item(index);
		} else
			folder = folderList.item(index);
	}
	if (folder != null) {
		if (folder.nodeName == "favorites")
			targetFolderName = "main";
		else
			targetFolderName = folder.getAttribute("title");

		var xmlFavoriteList= parentFolder.selectNodes("favorite"); 
		var favListLen=xmlFavoriteList.length;
		var favArray;
		var indexStr = paramsArray["favoriteIndex"];
		if (indexStr != null && indexStr!="") {
			favArray = indexStr.split("-");
		}
		var len = favArray.length;
		var favNode;
		cnt = 0;
		var rc=0;
		for (var i = len-1; i >= 0; i--) {
			if(favArray[i] != null && favArray[i] != "") {
				var index=parseInt(favArray[i]);
				if(index < favListLen){
					favNode = xmlFavoriteList.item(index);
					rc = MoveTheFavorite(favNode, folder );
					if ( rc == 1){
						cnt ++ ;
					}else if ( rc == 2 ){
						return -1;
					}
				}
			}
		}

	}
	return cnt;
}

function MoveTheFavorite( fav , folder)
{
	var rc = 0;
	var favName = fav.selectSingleNode("title").text;
	var folderName = folder.getAttribute("title");
	if ( folderName == null ) folderName = "Main Folder";



	var favoritesList = folder.selectNodes("favorite");
	var dupNode = searchFavorites( favoritesList, favName, false);
	if ( dupNode)
	{
		var str = "<P>The folder ("+folderName+") already contains a favorite with the name: <EM>"+favName+"</EM>.</P>";
		str += "This favorite will not be moved.";
		TVShell.PanelManager.CustomMessageBox( str ,"", "OK", 0,"",	 false,MGX_ICON_WARNING, MGX_SIZE_SMALL);
		return rc;
	}

	if ( MoveFavorite(folder, fav) == 0 )
		rc = 1;

	return rc;
	
}


function callMoveFavorites()
{
	var oCurrentNode=findCurrentNode();
	var xmlFavoriteList= oCurrentNode.selectNodes("favorite");
	var favListLen=xmlFavoriteList.length;
	var indexStr='';
	var inputs = document.all.tags("input");
	for (var j = 0; j < favListLen; j++) {
		if(inputs[j].checked ==true){
			if(indexStr!='')
				indexStr += '-'
			indexStr += j;
		}
	}
	if(indexStr!=''){		
		paramsArray["favoriteIndex"]=indexStr;
		paramsArray["action"] = "MoveFavorites-ChooseFolder";
		setTimeout("DrawMoveFavoritesChooseFolder();",100);
		return true;
	}else {
		TVShell.PanelManager.CustomMessageBox("Please select a favorite to move.","", "OK", 0,"", 1, MGX_ICON_WARNING, MGX_SIZE_SMALL);
		return false;
	}
}

// track state of folders thru query string
function showFolder(id)
{
	var sLocation = thisPanel.URL;
	var aValues = buildParams();
	id = escape(id);
	var targetURL= sLocation.substr(0,(sLocation.indexOf("?")>0)?sLocation.indexOf("?"):sLocation.length) + "?folder=" + id;
	if(aValues["action"]!=null && aValues["action"]!="")
		targetURL +="&action="+aValues["action"];
	thisPanel.GotoURL(targetURL);
}

function navigate(sId)
{
	var sPath = "//favorite[@id = '" + escapeString(sId) + "']";
	var oNode = g_oFavXml.selectSingleNode(sPath);
	if (null != oNode) {
		navigateID=sId;	
		var href=oNode.selectSingleNode("href").text;	
		TVShell.Message("Favorites: href="+href+" navigateId="+navigateID);
		if(href!=null && href!="")
			ShowMainPanelWithURL(href);
	} else {
		var oErr = new Error();
		oErr.description += "No node found for " + sPath;
		throw(oErr);
	}
}

function setNextURL(action)
{
	var sLocation = thisPanel.URL;
	var targetURL=sLocation.substr(0,(sLocation.indexOf("?")>0)?sLocation.indexOf("?"):sLocation.length);
	if (action != null && action != "")
		targetURL += "?action="+action;
	if (paramsArray["folder"] != null && paramsArray["folder"] != "") {
		if(targetURL.indexOf("?")<=0)
			targetURL += '?';
		else
			targetURL += '&';
		targetURL += "folder="+paramsArray["folder"];
	}
	thisPanel.GotoURL(targetURL);
}


function syncOK()
{
	var isOK = false;

	var favoritesNode = g_oFavXml.selectSingleNode("//favorites");
	if ( ! g_RoamingAllowed ){
		favoritesNode.setAttribute("delaySync","true");
		return true;
	}
	
	if ( favoritesNode ){
		var lv = favoritesNode.getAttribute("v");
		var delayedSync = favoritesNode.getAttribute("delaySync");
		var needSync = favoritesNode.getAttribute("resync");

		if ( lv == null || lv == "" || delayedSync == "true" || needSync == "true" ){
			TVShell.EventLog.Important("favorites.html          favorites needs to sync up.  lv:" + lv + "  delayedSync:" + delayedSync + "  resync:" + needSync);
			isOK = false;
		}
		else
			isOK= true;
	}

	if ( !isOK ){
		var result=0;
		result = TVShell.PanelManager.CustomMessageBox("<p>Your favorites list is not up to date.</p>When you choose <b>OK</b>, your favorites list will be updated and you will be able to add or edit favorites.","", "Cancel;OK", 1,"", 1, MGX_ICON_WARNING, MGX_SIZE_LARGE);
		if ( result == 1 )
			gotoSync();
	}

	return isOK;
		

}

var numOfMovedFav = 0;
var numOfDeletedFav = 0;
var numOfDeletedFolder = 0;
var targetFolderName = null;
var gClk_id="";

function handleMouse(id)
{
	gClk_id = id;
}

// general click handler to call rename and delete functions
function handleAction(sVerb) 
{
	TVShell.Message("favorites.html: handleAction sVerb="+sVerb);
	var sId = "";

	// If we're handling the onclick event, return false
	if (sVerb != null && sVerb != "") {
		if ( window.event ){
			sId = window.event.srcElement.clk_id;
			window.event.returnValue = false;
		}
	
		if (b_ActionDone) {
			return;
		} 
		switch(sVerb){
		case "addfavorite":
			setNextURL("AddFavorite");
			b_ActionDone = true;
			break;
		case "createFavorite":
			var newTitle = removeUnusedSpace(document.all.addFavTitle.value);
			if( newTitle.length <= 0 ){
				alert("Please enter a name for this favorite.");
				document.all.addFavTitle.value= getDocumentTitle();
				document.all.addFavTitle.focus();
				return;
			} 
			else if ( !ValidateName( newTitle, false ) ){
				document.all.addFavTitle.focus();
				return;
			}
			
			thefavURL = document.all.addFavURL;
			var newURL="";
			if ( thefavURL ){
				newURL = cleanName(thefavURL.value);
				if ( newURL == null  || newURL.length <= 0 ){
					TVShell.PanelManager.CustomMessageBox("The Web address cannot be blank.","", "OK", 0,"", false, MGX_ICON_WARNING, MGX_SIZE_SMALL);
					document.all.addFavURL.value= GetTargetPanelURL();
					return;
				}
				var lowerURL = newURL.toLowerCase();
				var validURL = /^\s*[a-zA-Z]{2,}\:(?:\/\/)?\w/.test(lowerURL);
				var badURL = false;

				if ( !validURL ){
					validURL = isMsnTVURL(lowerURL);
					if ( !validURL )
						badURL = true;
					else{
						if (! isMsnTVURL(currURL) )  // cannot enter msntv:/
							badURL = true;
					}       
				}
				else{
					var fileURL = /^file:.*/.test(lowerURL);
					if (fileURL )
						badURL = true;
				}

				if (badURL){
					TVShell.PanelManager.CustomMessageBox("<p>Invalid Web address.</P><p>A Web address usually starts with <b>http://</b> or <b>https://</b>.</p>","", "OK", 0,"", false, MGX_ICON_WARNING, MGX_SIZE_SMALL);
					document.all.addFavURL.value= GetTargetPanelURL();
					return;
				}
			}

			
			var index;
			if (document.all.ChooseFolderRadio) {
				for (var i = 0; i < document.all.ChooseFolderRadio.length; i++) {
					if (document.all.ChooseFolderRadio[i].checked == true) {
						index = i;
						break;
					}
				}
			} else 
				index = 0;
			if (callCreateFavorite(index) != null) {
				var str="Favorite has been successfully saved.";
				setTimeout("PanelManager.Hide(window.name);",animationTimeOut);
				TVShell.PanelManager.AnimationMessageBox(str, "msntv:/Favorites/img/FavSave.gif", "Task_Complete", animationTimeOut);
				b_ActionDone = true;
				if ( TVShell.UserManager.CurrentUser.FavoritesCount > MAX_RECENT_THUMBNAILS )
					g_favoritesMgr.saveMostRecentThumbNails(MAX_RECENT_THUMBNAILS);
			}
			break;
		case "organizeFavorites":
			g_NeedReload=true;
			paramsArray["action"] = "OrganizeFavorites";
			DrawOrganizeFavorites();
			break;

		case "addNewFolder":
			paramsArray["action"] = "AddFolder";
			DrawAddFolder();
			break;
		case "createFolder":
			if (createFolderExit() != 0) {
				b_ActionDone = true;
			}
			break;

		case "deleteFavorites":
			paramsArray["action"] = "DeleteFavorites";
			DrawDelete();
			break;
		case "delete":
			var rc=callDelete();
			if ( rc == 0 || rc == 1 ){
				setTimeout("handleAction('organizeFavorites');",1000);
				if ( rc == 0) {
					var str = "Deleted.";
					TVShell.PanelManager.AnimationMessageBox(str, "msntv:/Panels/Images/TaskCompleted.gif", "Task_Complete", animationTimeOut);
				}
			}
			break;

		case "renameFavorites":
			paramsArray["action"] = "RenameFavorites";
			DrawRenameList();
			break;
		case "moveFavorites":
			paramsArray["action"] = "MoveFavorites";
			DrawMoveFavorites();
			break;
		case "moveFavoritesChooseFolder":
			callMoveFavorites();
			break;			
		case "moveToFolder":
			if ( callMoveToFolder() > 0 ) {
				var str="Moving ";
				if (numOfMovedFav > 1)
					str +=" favorites";
				else
					str +=" a favorite";
				str+=" to <b>" + targetFolderName +"</b> folder";
				TVShell.PanelManager.AnimationMessageBox(str, "msntv:/Favorites/img/FavMove.gif", "Task_Complete", animationTimeOut);
			}
			break;

		case "display":	// navigate to a sub folder
			if ((sId == "" || sId == null) && gClk_id != ""){
				sId = gClk_id;
				gClk_id = "";
			}
			g_NeedReload=true;
			paramsArray["folder"] = sId;
			DrawShowFavorites();
			break;
		case "navigate": // navigate to a favorite, the favorites panel does not change
			if ((sId == "" || sId == null) && gClk_id != "" ){
				sId = gClk_id;
				gClk_id = "";
			}
			navigate(sId);
			break;
		case "shortcuts":
			g_NeedReload=true;
			paramsArray["action"] = "Shortcuts";
			DrawShortcuts();
			break;
		case "showFavorites":
			paramsArray["action"] = "";
			DrawShowFavorites();
			break;
		case "showRootFavorites":
			g_prevFolderID = paramsArray["folder"];
			paramsArray["folder"] = "";
			DrawShowFavorites();
			g_prevFolderID = "";
			break;
		case "dismissPanel":
			PanelManager.Hide(window.name);
			break;
		}
	}
}

function init()
{
	// There are rare occasions, usally under stress with no favcache.xml, where the behavior is  not properly instantiated
	// In these cases, which we detect via an error calling favorites.xml, handle the error by:
	//   Calling HandleError() which shows a dialog and trace message in debug
	//   Calling location.reload() to reload the page in 15 seconds
	//   Returning from the function

	try
	{
		g_oFavXml = g_favoritesMgr.xml;
		if ( !g_oFavXml.preserveWhiteSpace )
			g_oFavXml.preserveWhiteSpace = true;
	}
	catch(e)
	{
		e.description += "\r\nError getting favorites.xml";
		window.setTimeout("location.reload()",15000);
		return;
	}
 		var favoritesList = g_oFavXml.selectNodes("//favorite");
		var folderList = g_oFavXml.selectNodes("//favfolder");

		TVShell.UserManager.CurrentUser.FavoritesCount = favoritesList.length+folderList.length;
		TVShell.Message("Favorites.html   total folders=" + folderList.length + "  total favorites=" + favoritesList.length + "  CurrentUser.FavoritesCount=" + TVShell.UserManager.CurrentUser.FavoritesCount);

		var sShowThumbs = g_oFavXml.documentElement.getAttribute("showthumbs");
		if (sShowThumbs == null) {
			sShowThumbs = "true";
			g_oFavXml.documentElement.setAttribute("showthumbs", sShowThumbs);
		}
		var sShowUrls = g_oFavXml.documentElement.getAttribute("showurls");
		if (sShowUrls == null) {
			sShowUrls = "true";
			g_oFavXml.documentElement.setAttribute("showurls", sShowUrls);
		}

		var sShowFeatured = g_oFavXml.documentElement.getAttribute("showfeatured");
		if (sShowFeatured == null) {
			sShowFeatured = "true";
			g_oFavXml.documentElement.setAttribute("showfeatured", sShowFeatured);
		}
		thisPanel.ClearTravelLog();
		paramsArray = buildParams();

		var authServerEntry = TVShell.UserManager.CurrentUser.ServiceList("Skydrive::AuthServer");
		var appIdEntry = TVShell.UserManager.CurrentUser.ServiceList("Skydrive::AppId");

		if ( authServerEntry != null && appIdEntry != null )
		{
			g_RoamingAllowed = true;
			g_serviceTarget = authServerEntry.URL;
			g_servicePolicy =  authServerEntry.Description;
		
			g_appID = appIdEntry.Description;

			TVShell.Message("Favorites.html   target=" + g_serviceTarget + "  policy=" + g_servicePolicy + "  appID=" + g_appID );
		
			RequestToken(false); //from cache
		}
		else
		{
			TVShell.Message("Favorites.html                NO   authServer or appId service list entry found.");
		}
		
		switch(paramsArray["action"]){
			case "Shortcuts":
				DrawShortcuts();
				document.all.Done.focus();
				break;
			case "AddFavorite":
				DrawAddFavorite();
				break;
			case "ShowFavorites":
			default:
				DrawShowFavorites();
				if(document.all.firstBar)
					document.all.firstBar.focus();
				else
					document.all.Done.focus();
				break;
				
		}
}


function GetThumbNailURL(node)
{
	return g_favoritesMgr.thumbNailURL(node);
}
function GetCurrentThumbnailURL()
{
    var thumnailURL="";
	var popupPanel=null;
	var mainPanel=TVShell.PanelManager.Item("main")
	var showingPopup = ((popupPanel=PanelManager.Item("popuppanel")) && popupPanel.State == 0);
	var targetPanel = (showingPopup ? popupPanel : mainPanel);

	if(targetPanel.Name!="popuppanel")
		thumnailURL = TVShell.ThumbnailManager.URL;
	else
	{
		var ContentSync	= new ActiveXObject("MSNTV.ContentSync");
		thumnailURL=ContentSync.TempPath + "\\PopupThumbnail.jpg";
	}
	return thumnailURL;
}
function DrawAddFavorite()
{
    var folderList = g_oFavXml.selectNodes("//favorites/favfolder");   // all folder nodes
    var folderListLen = folderList.length;
	
	document.all.PanelSubHeader.innerHTML = "Save as a favorite";
	
	var pcwszUrl = GetTargetPanelURL();

	var strArray = new Array();
	var k=0;
	
	strArray[k++] ="<table width=100% valign=top style=\"margin-top:10px;\" cellspacing=0 cellpadding=0>";
	strArray[k++] =	"<tr><td style=\"border-bottom:2px solid #438BCD \">";
	strArray[k++] =		"<table style=\"margin-left:8px;\" cellspacing=0 cellpadding=0 border=0>";
	strArray[k++] =			"<tr><td><table cellspacing=0 cellpadding=0 border=0>";
	strArray[k++] =			"<tr><td width=103 height=76 rowspan=3><img style=\"width:96px; height:66px; border:1px solid black;\" src=\"";
	strArray[k++] =				"file:" + GetCurrentThumbnailURL() ;
	strArray[k++] =					"\"></td><td width=6></td><td valign=bottom>Name of new favorite:</td></tr>";
	strArray[k++] =			"<tr><td></td><td></td></tr>";
	strArray[k++] =			"<tr><td></td><td><input type=text id=addFavTitle class=\"inputText\" nextright=Add size=23 maxlength=242></td></tr>";
	strArray[k++] =				"</table></td></tr>";
	strArray[k++] =			"<tr><td height=4></td></tr>";
//	strArray[k++] =			"<tr><td><span id=addFavURL class=addFavHrefContent></span></td></tr>";
	strArray[k++] =			"<tr><td><input type=text id=addFavURL class=inputText size=33 maxlength=255></td></tr>";
	strArray[k++] =			"<tr><td height=10></td></tr>";
	strArray[k++] =		"</table></td></tr>";
	
	if (folderListLen > 0) {
		strArray[k++] =	"<tr><td height=4></td></tr>";
		strArray[k++] =	"<tr><td><table style=\"margin-left:8px;\" cellspacing=0 cellpadding=0 border=0>";
		strArray[k++] =				"<tr><td>From the list below, select a folder for this favorite.   Then choose <b>Save</b>.</td></tr>";
		strArray[k++] =				"<tr><td height=6></td></tr>";
		strArray[k++] =				"<tr><td><table cellspacing=0 cellpadding=0 border=0>";
		strArray[k++] =						"<tr><td valign=middle align=center><input type=radio id=firstBar name=ChooseFolderRadio value=\"ROOT\" checked ></td>";
		strArray[k++] =						"<td width=6></td><td>Main folder</td></tr>";
		strArray[k++] =					"</table></td></tr>";

		var favCount=0;
		// go thru each folder item
		for (var i = 0; i < folderListLen; i++){
			var folder = folderList.item(i);
			var id = folder.getAttribute("id");
			var title = folder.getAttribute("title");
			favCount = folder.selectNodes("favorite").length;
			strArray[k++] =	"<tr><td height=4></td></tr>";
			strArray[k++] =	"<tr><td><table cellspacing=0 cellpadding=0 border=0>";
			strArray[k++] =					"<tr><td width=15></td><td valign=middle align=center><input type=radio name=ChooseFolderRadio id=\"radio"+i+"\" ></td>";
			strArray[k++] =					"<td width=6></td><td><font class=\"addFavFolderTitleContent\">" + removeTags(title) +" <span style=\"font-size:14px;\">(";
			strArray[k++] =					favCount  + ")</span></font></td></tr></table></td></tr>";
		}
		strArray[k++] = "</table></td></tr>";
	}
	else {
		strArray[k++] =	"<tr><td height=4></td></tr>";
		strArray[k++] =	"<tr><td><table style=\"margin-left:8px;\" cellspacing=0 cellpadding=0 border=0>";
		strArray[k++] =	"<tr><td>To save this Web page as a favorite, choose <b>Save</b>.</td></tr>";
		strArray[k++] =	"</table></td></tr>";
	}										
	strArray[k++] = "</table>";
	document.all.leftContent.innerHTML=strArray.join("");
	delete strArray;
	
	document.all.addFavTitle.value = getDocumentTitle();
	document.all.addFavURL.innerText = pcwszUrl;

	strArray = new Array();
	k=0;
	strArray[k++] = "<msntv:CustomButton id=\"Add\" class=\"sidebarButton\" label=\"Save\" onClick=\"handleAction(\'createFavorite\')\" />";
	strArray[k++] = "<msntv:CustomButton id=\"Cancel\" class=\"sidebarButton\" label=\"Cancel\" onClick='handleAction(\"dismissPanel\");' />";
	document.all.rightMenu.innerHTML=strArray.join("");
	delete strArray;
	strArray=null;

	if (syncOK() == false ){
		document.all.Add.disabled = true;
		document.all.Cancel.focus();
	}
	else
		document.all.Add.focus();
		
	
}

function CutLongTitle(s)
{
	if (s.length <20)
		return s;
	else
		return s.substring(0,20)+'...';
}

function ShowEmptyError( n )
{
	var str;
	
	switch( n )
	{
		case 1:
			str = "There are no favorites or folders to remove.";
			break;
		case 2:
			str = "There are no favorites or folders to rename.";
			break;
		case 3:
			str = "There are no favorites to move.";
			break;
		default:
			str = "There are no favorites or folders to act on.";
			break;
	}
	TVShell.PanelManager.CustomMessageBox( str ,"", "OK", 0,"",	 false,MGX_ICON_WARNING, MGX_SIZE_SMALL);
}

function DrawOrganizeFavorites()
{
	if ( ! syncOK() )
		return;
		
	var node =findCurrentNode();
	var xmlFavFolderList= node.selectNodes("favfolder");
	var favfolderListLen=hasFolder(xmlFavFolderList.length);
	var xmlFavoriteList= node.selectNodes("favorite");
	var favoriteListLen=xmlFavoriteList.length;
	var strArray=null;
	var i=0;
	document.all.scroller.MyDoScroll("scrollToStart");

	strArray = new Array();
	if (node.nodeName == "favorites")
		strArray[i++] = "Main folder - Organize";
	else {
		strArray[i++] = "<table cellspacing=0 cellpadding=0 border=0>";
		strArray[i++] = 	"<tr><td><div style=\"padding:0px; height:35px; width:35px; border:0; behavior: url(#default#alphaImageLoader); src:img/FavIconFolderHeader.png;\"></div></td>";
		strArray[i++] = 	"<td width=8></td><td><font class=subHeaderTitle> ";
		strArray[i++] =  		removeTags(CutLongTitle(node.getAttribute("title")));
		strArray[i++] = 	"</font> - Organize this folder</td></tr></table>";
	}
	document.all.PanelSubHeader.innerHTML = strArray.join("");
	strArray = null;

	strArray = new Array();
	i=0;

	strArray[i++]="<table style=\"margin-top:10px; margin-left:8px;\" valign=top cellspacing=0 cellpadding=0 border=0>";
	if (node.nodeName == "favorites") {
		strArray[i++] = "<tr><td><a id=\"Add_Folder\" onClick=\"handleAction(\'addNewFolder\')\" tabindex=0><b>Add a folder</b></a></td></tr>";
		strArray[i++] = "<tr><td>Add a new folder</td></tr>";
		strArray[i++] = "<tr><td height=15></td></tr>";
	}
	if (favoriteListLen == 0 && favfolderListLen == 0) {
		strArray[i++] = "<tr><td><a id=\"Delete_OrganizeFavorites\" onClick=\"ShowEmptyError(1)\" tabindex=0><b>Delete</b></a></td></tr>";
		strArray[i++] = "<tr><td>Remove unwanted folders and favorites</td></tr>";
		strArray[i++] = "<tr><td height=15></td></tr>";
		strArray[i++] = "<tr><td><a id=\"Rename_OrganizeFavorites\" onClick=\"ShowEmptyError(2)\" tabindex=0><b>Edit</b></a></td></tr>";
		strArray[i++] = "<tr><td>Edit favorites and folders</font></td></tr>";
	} else {
		strArray[i++] = "<tr><td><a id=\"Delete_OrganizeFavorites\" onClick=\"handleAction(\'deleteFavorites\')\" tabindex=0><b>Delete</b></a></td></tr>";
		strArray[i++] = "<tr><td>Remove unwanted folders and favorites</td></tr>";
		strArray[i++] = "<tr><td height=15></td></tr>";
		strArray[i++] = "<tr><td><a id=\"Rename_OrganizeFavorites\" onClick=\"handleAction(\'renameFavorites\')\" tabindex=0><b>Edit</b></a></td></tr>";
		strArray[i++] = "<tr><td>Edit favorites and folders</font></td></tr>";
	}
	if (favoriteListLen == 0) {
		strArray[i++] = "<tr><td height=15></td></tr>";
		strArray[i++] = "<tr><td><a id=\"Move_OrganizeFavorites\" onClick=\"ShowEmptyError(3)\" tabindex=0><b>Move favorites</b></a></td></tr>";
		strArray[i++] = "<tr><td>Move favorites to other folders</td></tr>";
	} else {
		strArray[i++] = "<tr><td height=15></td></tr>";
		strArray[i++] = "<tr><td><a id=\"Move_OrganizeFavorites\" onClick=\"handleAction(\'moveFavorites\')\" tabindex=0><b>Move favorites</b></a></td></tr>";
		strArray[i++] = "<tr><td>Move favorites to other folders</td></tr>";
	}
	strArray[i++] = "</font></table>";
	document.all.leftContent.innerHTML=strArray.join("");
	delete strArray;
	strArray=null;

	document.all.rightMenu.innerHTML="<msntv:CustomButton id=\"Done\" class=\"sidebarButton\" label=\"Done\" onClick='favGoBack();' />";
	
	if (document.all.Add_Folder)
		document.all.Add_Folder.focus();
	else
		document.all.Delete_OrganizeFavorites.focus();

	g_backFunc = "handleAction(\"showFavorites\")";
	
}
function OnKeyPressAddFolder()
{
	var e = window.event;
	if (window.event.keyCode == 13) {
		createFolderExit();
	}
	return;
}

function createFolderExit()
{	
	if (callCreateFolder() != null) {
		var str="You have successfully added the folder <b>" + AddedFolderName + "</b>.";
		TVShell.PanelManager.AnimationMessageBox(str, "msntv:/Panels/Images/TaskCompleted.gif", "Task_Complete", animationTimeOut);
		setTimeout("handleAction('organizeFavorites');",100);
		return 1;
	}
	return 0;
}

function DrawAddFolder()
{
	document.all.PanelSubHeader.innerHTML = "Main folder - Add a folder";

	var strArray = new Array();
	var i=0;
	strArray[i++] = "<table valign=top style=\"margin-top:10px; margin-left:8px;\" cellspacing=0 cellpadding=0 border=0>";
	strArray[i++] =		"<tr><td>Type a name for the folder you want to add, and then choose <b>Add</b>.</td></tr>";
	strArray[i++] =		"<tr><td height=15></td></tr>";
	strArray[i++] =		"<tr><td><table cellspacing=0 cellpadding=0 border=0>";
	strArray[i++] =					"<tr><td>New folder:</td><td width=8></td><td><input id=\"folderTitleText\" class=\"inputText\" type=text maxlength=242 size=23 onblur=\"document.all.Add_AddFolder.focus()\" onKeyPress=\"OnKeyPressAddFolder()\"></td></tr>";
	strArray[i++] =				"</table></td></tr></table>";
	document.all.leftContent.innerHTML=strArray.join("");
	delete strArray;

	strArray = new Array();
	i=0;
	strArray[i++] = "<msntv:CustomButton id=\"Add_AddFolder\" class=\"sidebarButton\" label=\"Add\" onClick='createFolderExit();' />";
	strArray[i++] = "<msntv:CustomButton id=\"Cancel\" class=\"sidebarButton\" label=\"Cancel\" onClick='favGoBack();' />";
	document.all.rightMenu.innerHTML=strArray.join("");
	delete strArray;
	strArray = null;

	document.all.folderTitleText.value = L_NEWFOLDERNAME_TEXT;
	document.all.folderTitleText.focus();
	document.all.folderTitleText.select();

	g_backFunc = "handleAction(\"organizeFavorites\")";

}

function setDeleteArray(i)
{
	var inputs = document.all.tags("input");
	var newColor = "transparent";
	if (inputs[i].checked == true)
		newColor = PictureBKColor;

	document.getElementById("td" + i).bgColor = newColor;
}

function deleteExit()
{
	handleAction( 'delete' );
}

function DrawDelete()
{
	var node = findCurrentNode();
	var xmlFavFolderList = node.selectNodes("favfolder");
	var favfolderListLen = hasFolder(xmlFavFolderList.length);
	var xmlFavoriteList = node.selectNodes("favorite");
	var favoriteListLen = xmlFavoriteList.length;

	var strArray = new Array();
	var k=0;
	if (node.nodeName == "favorites") {
		if (favoriteListLen > 0) {
			if (favfolderListLen > 0)
				strArray[k++] = "Main folder - Delete a favorite or folder";
			else
				strArray[k++] = "Main folder - Delete a favorite";
		} else
			strArray[k++] = "Main folder - Delete a folder";
	}else{
		strArray[k++] = "<table cellspacing=0 cellpadding=0 border=0>";
		strArray[k++] =		"<tr><td><div style=\"padding:0px; height:35px; width:35px; border:0; behavior: url(#default#alphaImageLoader); src:img/FavIconFolderHeader.png;\"></div></td>";
		strArray[k++] =			"<td width=8></td><td><font class=subHeaderTitle>" + removeTags(CutLongTitle(node.getAttribute("title"))); 
		strArray[k++] = 			"</font> - Delete a favorite</td></tr></table>";
	}
	document.all.PanelSubHeader.innerHTML = strArray.join("");
	delete strArray;

	strArray = new Array();
	k=0;
	strArray[k++] = "<table width=100% cellspacing=0 cellpadding=0 border=0 style=\"margin-top:10px;\">";
	strArray[k++] =	"<tr><td ";
	
	if (favfolderListLen != 0 || favoriteListLen != 0) 
		strArray[k++] = "style=\"border-bottom:2px solid #438BCD \" ";
	
	strArray[k++] =	"><table cellspacing=0 cellpadding=0 border=0 style=\"margin-left:8px;\">";
	if (favoriteListLen > 0) {
		if (favfolderListLen > 0)
			strArray[k++] =	"<tr><td>To delete a favorite or a folder and all the favorites in it, check the box next to it, and then choose <b>Delete</b>.</td></tr>";
		else
			strArray[k++] =	"<tr><td>To delete a favorite, check the box next to it, and then choose <b>Delete</b>.</td></tr>";
	} else
		strArray[k++] =	"<tr><td>To delete a folder and all the favorites in it, check the box next to it, and then choose <b>Delete</b>.</td></tr>";
	
	strArray[k++] =		"<tr><td height=10></td></tr>";
	strArray[k++] =	"</table></td></tr>";
	
	var i,j;
	for (i = 0; i < favoriteListLen; i++) {
		var xmlFavorite = xmlFavoriteList.item(i);
		var title = xmlFavorite.selectSingleNode("title").text;
		var href = xmlFavorite.selectSingleNode("href").text;
		if (xmlFavorite) {
			strArray[k++] = "<tr><td id=\"td"+ i +"\" bgColor=transparent style=\"border-bottom:2px solid #438BCD \">";
			strArray[k++] =		"<table height=50 cellspacing=0 cellpadding=0 border=0 style=\"margin-left:8px;\">";
//			strArray[k++] =		"<tr><td height=100% valign=middle align=center><input name=deleteRadio type=radio ";
			strArray[k++] =		"<tr><td height=100% valign=middle align=center><input type=checkbox ";
			
			if(i == 0)
				strArray[k++] =		" id=firstBar ";
			else
				strArray[k++] =		" id=\"checkBox"+i+"\" ";
							
			strArray[k++] =			" onClick=\"setDeleteArray("+ i +")\" nextright=Right ";
			strArray[k++] =                   "favid=\"" + xmlFavorite.getAttribute("id") + "\"></td><td width=8></td>";
			strArray[k++] =			"<td width=50 height=100% valign=middle align=center><img style=\"border: 1px solid black;\" width=50 height=35 src=\"";
				
			var thumbNailURL=GetThumbNailURL(xmlFavorite);
			if(thumbNailURL!=null && thumbNailURL!="")
				strArray[k++] =		"file:"+thumbNailURL;
			else
				strArray[k++] =		"img/fav-default.gif";
			
			strArray[k++] =			"\"></td><td width=6></td>";
			strArray[k++] =			"<td valign=middle height=100%><font class=\"titleContent\">"+ cleanFavoriteName(removeTags(title)); 
			strArray[k++] =		"</font></td></tr></table></td></tr>";
		}
	}

	var favCount=0;
	for (j = i; j < favfolderListLen + favoriteListLen; j++) {
		var xmlFavFolder = xmlFavFolderList.item(j-favoriteListLen);
		var id = xmlFavFolder.getAttribute("id");
		var title = xmlFavFolder.getAttribute("title");
		favCount = xmlFavFolder.selectNodes("favorite").length;
		if (xmlFavFolder) {
			strArray[k++] =	"<tr><td id=\"td"+ j +"\" bgColor=transparent style=\"border-bottom:2px solid #438BCD \">";
			strArray[k++] =		"<table height=50 cellspacing=0 cellpadding=0 border=0 style=\"margin-left:8px;\">";
//			strArray[k++] =			"<tr><td height=100% valign=middle align=center><input name=deleteRadio type=radio ";
			strArray[k++] =			"<tr><td height=100% valign=middle align=center><input type=checkbox ";
			
			if (j == 0)
				strArray[k++] = 		" id=firstBar ";
			else 
				strArray[k++] =		" id=\"checkBox"+j+"\" ";
			
			strArray[k++] =			" onClick=\"setDeleteArray("+ j +")\" nextright=Right ";
			strArray[k++] =                  "favid=\"" + xmlFavFolder.getAttribute("id") + "\"></td><td width=8></td>";
			strArray[k++] =			"<td width=50 height=100% valign=middle align=center><div style=\"width:35px; height:35; border:0;behavior: url(#default#alphaImageLoader); src:img/FavIconFolderOrganize.png;\"></div></td>";
			strArray[k++] =			"<td width=6></td>";
			strArray[k++] =			"<td valign=middle height=100%><font class=\"titleContent\">"+ removeTags(title); 
			strArray[k++] =		" <span style=\"font-size:14px;\">(";
			strArray[k++] =			favCount + ")</span></font></td></tr></table></td></tr>";
		}
	}

	strArray[k++] = "</table>";
	document.all.leftContent.innerHTML=strArray.join("");
	delete strArray;

	strArray = new Array();
	k=0;
	strArray[k++] = "<msntv:CustomButton id=\"Right\" class=\"sidebarButton\" label=\"Delete\" onClick='deleteExit();' />";
	strArray[k++] = "<msntv:CustomButton id=\"Cancel\" class=\"sidebarButton\" label=\"Cancel\" onClick='favGoBack();' />";
	document.all.rightMenu.innerHTML=strArray.join("");
	delete strArray;
	strArray = null;

	if(document.all.firstBar)
		document.all.firstBar.focus();
	else
		document.all.Cancel.focus();

	g_backFunc = "handleAction(\"organizeFavorites\")";
	
}


var g_renameID=null;
function setRenameId( id )
{
	var ischecked = document.getElementById(id).checked;
	TVShell.Message("Favorites.html           setRenameid: " + id + " checked: " + ischecked);
	if (ischecked == true ){
		if ( g_renameID != null )
			document.getElementById( "td"+g_renameID ).bgColor = "transparent";
		
		document.getElementById("td"+id).bgColor = PictureBKColor;
		g_renameID = id;
	}
	else
		document.getElementById("td"+id).bgColor = "transparent";
	
	
}

function DrawRenameList()
{
	var node = findCurrentNode();
	var xmlFavFolderList = node.selectNodes("favfolder");
	var favfolderListLen = hasFolder(xmlFavFolderList.length);
	var xmlFavoriteList = node.selectNodes("favorite");
	var favoriteListLen = xmlFavoriteList.length;
	var strArray = new Array();
	var k=0;
	g_renameID = null;
	document.all.scroller.MyDoScroll("scrollToStart");
	if (node.nodeName == "favorites") {
		if (favoriteListLen > 0) {
			if (favfolderListLen > 0)
				strArray[k++] = "Main folder - Edit a favorite or folder";
			else
				strArray[k++] = "Main folder - Edit a favorite";
		} else
			strArray[k++] = "Main folder - Edit a folder";
	}else{
		strArray[k++] = "<table cellspacing=0 cellpadding=0 border=0>";
		strArray[k++] =		"<tr><td><div style=\"padding:0px; height:35px; width:35px; border:0; behavior: url(#default#alphaImageLoader); src:img/FavIconFolderHeader.png;\"></div></td>";
		strArray[k++] =			"<td width=8></td><td><font class=subHeaderTitle>" + removeTags(CutLongTitle(node.getAttribute("title"))); 
		strArray[k++] = 		"</font> - Edit a favorite</td></tr></table>";
	}
	document.all.PanelSubHeader.innerHTML = strArray.join("");
	delete strArray;

	strArray = new Array();
	k=0;
	strArray[k++] = "<table width=100% cellspacing=0 cellpadding=0 border=0 style=\"margin-top:10px;\">";
	strArray[k++] =		"<tr><td><table cellspacing=0 cellpadding=0 border=0 style=\"margin-left:8px;\"><tr><td style=\"border-bottom:2px solid #438BCD \">Select a ";
	if (favoriteListLen > 0) {
		if (favfolderListLen > 0)
			strArray[k++] = "favorite or folder";
		else
			strArray[k++] = "favorite";
	} else
		strArray[k++] = "folder";
	
	strArray[k++] =		" below, and then choose <b>Edit</b>.</td></tr><tr><td height=10></td></tr>";
	strArray[k++] = "</table></td></tr>";
	var i,j;
	var focusID=null;

	for (i = 0; i < favoriteListLen; i++) {
		var xmlFavorite = xmlFavoriteList.item(i);
		var title = xmlFavorite.selectSingleNode("title").text;
		var id = xmlFavorite.getAttribute("id");
		if(xmlFavorite){
			strArray[k++] = "<tr><td id=\"td"+ id+"\" bgColor=transparent style=\"border-bottom:2px solid #438BCD \" >";
			strArray[k++] =		"<table height=50 cellspacing=0 cellpadding=0 border=0 style=\"margin-left:8px;\">";
			strArray[k++] =		"<tr><td height=100% valign=middle align=center><input type=radio name=renameRadio id=\"";
			strArray[k++] = 		id + "\" ";
			strArray[k++] =			" onClick=\"setRenameId(this.id)\" nextright=Right></td><td width=8></td>";
			strArray[k++] =			"<td width=50 height=100% valign=middle align=center><img style=\"border: 1px solid black;\" width=50 height=35 src=\"";
				
			var thumbNailURL=GetThumbNailURL(xmlFavorite);
			if(thumbNailURL!=null && thumbNailURL!="")
				strArray[k++] =		"file:"+thumbNailURL;
			else
				strArray[k++] =		"img/fav-default.gif";
			
			strArray[k++] =			"\"></td><td width=6></td>";
			strArray[k++] =			"<td valign=middle height=100%><font class=\"titleContent\">"+ cleanFavoriteName(removeTags(title)); 
			strArray[k++] =		"</font></td></tr></table></td></tr>";
			if (i==0)
				focusID = id;

		}

	}
	

	var favCount=0;
	for (j=0; j < favfolderListLen; j++) {
		var xmlFavFolder = xmlFavFolderList.item(j);
		var id = xmlFavFolder.getAttribute("id");
		var title = xmlFavFolder.getAttribute("title");
		favCount = xmlFavFolder.selectNodes("favorite").length;
		if (xmlFavFolder) {
			strArray[k++] =	"<tr><td id=\"td"+ id+"\" bgColor=transparent style=\"border-bottom:2px solid #438BCD \" >";
			strArray[k++] =		"<table height=50 cellspacing=0 cellpadding=0 border=0 style=\"margin-left:8px;\">";
			strArray[k++] =			"<tr><td height=100% valign=middle align=center><input type=radio name=renameRadio id=\"";
			strArray[k++] = 			id + "\" ";			
			strArray[k++] =			" onClick=\"setRenameId(this.id)\" nextright=Right></td><td width=8></td>";
			strArray[k++] =			"<td width=50 height=100% valign=middle align=center><div style=\"width:35px; height:35; border:0;behavior: url(#default#alphaImageLoader); src:img/FavIconFolderOrganize.png;\"></div></td>";
			strArray[k++] =			"<td width=6></td>";
			strArray[k++] =			"<td valign=middle height=100%><font class=\"titleContent\">"+ removeTags(title); 
			strArray[k++] =		" <span style=\"font-size:14px;\">(" + favCount;
			strArray[k++] = 		")</span></font></td></tr></table></td></tr>";
			if ( (i+j)==0)
				focusID = id;
		}
	}

	strArray[k++] = "</table>";
	document.all.leftContent.innerHTML=strArray.join("");
	delete strArray;

	strArray = new Array();
	k=0;
	strArray[k++] = "<msntv:CustomButton id=\"Right\" class=\"sidebarButton\" label=\"Edit\" onClick='DrawEditFavorite();' />";
	strArray[k++] = "<msntv:CustomButton id=\"Done\" class=\"sidebarButton\" label=\"Done\" onClick=\"favGoBack()\" />";
	document.all.rightMenu.innerHTML=strArray.join("");
	delete strArray;
	strArray = null;
	
	if(focusID != null){
		document.getElementById(focusID).focus();
	}else
		document.all.Cancel.focus();

	g_backFunc = "handleAction('organizeFavorites')";
	
}


function DrawEditFavorite()
{
	if ( g_renameID == null ){
		var str = "<P>Please select a favorite or a folder to edit</P>"
		TVShell.PanelManager.CustomMessageBox( str ,"", "OK", 0,"",	 false,MGX_ICON_WARNING, MGX_SIZE_SMALL);
		return;
	}

	document.all.scroller.MyDoScroll("scrollToStart");

	var xmlFavorite = g_oFavXml.selectSingleNode("//*[@id='"+g_renameID+"']");
	if ( xmlFavorite ){
		var strArray = new Array();
		var k=0;
		var theFavURL = null;
		strArray[k++] ="<table valign=top style=\"margin-top:10px; margin-left:8px;\" cellspacing=0 cellpadding=0 border=0>";
		if ( xmlFavorite.nodeName == "favorite" ){
			strArray[k++] = 	"<tr><td style=\"border-bottom:2px solid #438BCD \">Edit the name or Web address of the favorite, and choose <b>Save</b>.<td></tr>";
			strArray[k++] =	"<tr><td height=10></td></tr>"; 
			strArray[k++] = 	"<tr><td><table border=0>";
			strArray[k++] = 	"<tr><td  height=76><img style=\"width:96px; height:66px; border:1px solid black;\" src=\"";
				
			var thumbNailURL=GetThumbNailURL(xmlFavorite);
			if(thumbNailURL!=null && thumbNailURL!="")
				strArray[k++] = "file:"+thumbNailURL;
			else
				strArray[k++] = "img/fav-default.gif";

			theFavURL = xmlFavorite.selectSingleNode("href").text;
			strArray[k++] = 	"\"></td><td width=6></td>";
			strArray[k++] =    "<td><table border=0>";
			strArray[k++] = 	"<tr><td>Name:</td></tr><tr><td height=6></td></tr><tr><td><input type=text id=favTitle class=inputText size=22 maxlength=242 nextright=SaveEdit value=\"";
			strArray[k++] = 	cleanFavoriteName(removeTags(xmlFavorite.selectSingleNode("title").text));
			strArray[k++] =	"\"></td></tr></table border=1></td></tr></table></td></tr>";
			strArray[k++] =	"<tr><td height=10></td></tr><tr><td height=8 >Web address:</td></tr>";
//			strArray[k++] =	"<tr><td  height=6></tr><tr><td><input type=text id=favURL class=inputText size=34 maxlength=2048 nextright=SaveEdit value=\"";
			strArray[k++] =	"<tr><td  height=6></tr><tr><td><span class=editHrefContent>";
			strArray[k++] = 	theFavURL;
			strArray[k++] = 	"</span></td></tr>";
		}
		else
		{
			strArray[k++] = 	"<tr><td style=\"border-bottom:2px solid #438BCD \">Edit the name of the folder, and choose <b>Save</b>.<td></tr>";
			strArray[k++] =	"<tr><td height=10></td></tr>"; 
			strArray[k++] = 	"<tr><td><table><tr><td height=70 width=70><div style=\"padding:0px; width:60px; height:60px; border:0; behavior: url(#default#alphaImageLoader); src:img/FavIconFolderOrganize.png;\"></div></td><td width=6></td>";
			strArray[k++] = 	"<td><table border=0><tr><td>Name:</td></tr>";
			strArray[k++] = 	"<tr><td height=6></td></tr><tr><td><input type=text id=favTitle class=inputText size=25 maxlength=242 nextright=SaveEdit value=\"";
			strArray[k++] =	removeTags(xmlFavorite.getAttribute("title"));
			strArray[k++] = 	"\"></td></tr></table></td></tr></table></td></tr>";
		}

		strArray[k++] = "</table>";
		document.all.leftContent.innerHTML=strArray.join("");
		delete strArray;
		strArray = null;

//		if ( theFavURL != null && isMsnTVURL(theFavURL)){
//			document.all.favURL.disabled = true;
//		}
		
		strArray = new Array();
		k=0;
		strArray[k++] = "<msntv:CustomButton id=\"SaveEdit\" class=\"sidebarButton\" label=\"Save\" onClick='SaveEdit();' />";
		strArray[k++] = "<msntv:CustomButton id=\"Cancel\" class=\"sidebarButton\" label=\"Cancel\" onClick='favGoBack();' />";
		document.all.rightMenu.innerHTML=strArray.join("");
		delete strArray;
		strArray = null;

		document.all.favTitle.focus();
		document.all.favTitle.select();

		g_backFunc = "handleAction(\"renameFavorites\")";
		
	}
	
}


function isMsnTVURL( str ){
	var aMsnTVURL = /^msntv:\/\w/.test(str.toLowerCase());
	return aMsnTVURL;
}

function SaveEdit()
{
	var node = findCurrentNode();
	var editNode = node.selectSingleNode("*[@id='"+g_renameID+"']");
	var newTitle = cleanName(document.all.favTitle.value);
	if ( newTitle && newTitle.length > 0 ){
		if ( ! ValidateName( newTitle, (editNode.nodeName == "favfolder") ) ){
			return;
		}
	}
	else{
		var nodeName = "folder.";
		if ( editNode.nodeName == "favorite")
			nodeName = "favorite.";
			
		TVShell.PanelManager.CustomMessageBox("You must enter a name for this "+nodeName,"", "OK", 0,"", false, MGX_ICON_WARNING, MGX_SIZE_SMALL);
		return;
	}

	var currTitle="";
	var currURL="";
	if ( editNode.nodeName == "favorite"){
		currTitle = editNode.selectSingleNode("title").text;
		currURL = editNode.selectSingleNode("href").text;
	}
	else
		currTitle = editNode.getAttribute("title");
	
	if ( currTitle == newTitle  ){
		TVShell.Message("favorites.html		No changes to Edit favorite");
		setTimeout("handleAction('organizeFavorites');",1000);
		return;		
	}
	
	var dupNode = null;
	var favStr = "favorite";
	if ( editNode.nodeName == "favorite" ){
		var favList = node.selectNodes("favorite");
		dupNode = searchFavorites( favList, newTitle, false);
	}
	else{
		favStr = "folder";
		var fldList = node.selectNodes("favfolder");
		dupNode = searchFavorites(fldList, newTitle, true);
	}
	
	if  (dupNode && dupNode.getAttribute("id") != g_renameID ){
		var str = "<p>A " + favStr + " with that name already exists.</p>Please choose a different name.";
		TVShell.PanelManager.CustomMessageBox(str,"", "OK", 0,"", false, MGX_ICON_WARNING, MGX_SIZE_SMALL);
		return;
	}



	var hr = RenameFavorite(editNode, newTitle, currURL)
	
	if ( hr == 0 ){
		TVShell.PanelManager.AnimationMessageBox("Saving changes...", "msntv:/Panels/Images/TaskCompleted.gif", "Task_Complete", animationTimeOut);
		setTimeout("handleAction('organizeFavorites');",1000);
	}
		

}


function setMoveArray(i)
{
	setDeleteArray(i);
}

function DrawMoveFavorites()
{
	var node = findCurrentNode();
	var xmlFavoriteList = node.selectNodes("favorite");
	var favoriteListLen = xmlFavoriteList.length;
	if ( favoriteListLen == 0 ) return false;
	var xmlFavFolderList = node.selectNodes("favfolder");
	var favfolderListLen = hasFolder(xmlFavFolderList.length);

	document.all.scroller.MyDoScroll("scrollToStart");
	var strArray = new Array();
	var k=0;
	if (node.nodeName == "favorites") {
		if (favoriteListLen > 1) {
			strArray[k++] =  "Main folder - Move favorites";
		} else
			strArray[k++] = "Main folder - Move a favorite";
	}else{
		strArray[k++] = "<table cellspacing=0 cellpadding=0 border=0>";
		strArray[k++] =		"<tr><td><div style=\"padding:0px; height:35px; width:35px; border:0; behavior: url(#default#alphaImageLoader); src:img/FavIconFolderHeader.png;\"></div></td>";
		strArray[k++] =			"<td width=8></td><td><font class=subHeaderTitle>" + removeTags(CutLongTitle(node.getAttribute("title")));
		strArray[k++] =  			"</font> - Move a favorite</td></tr></table>";
	}
	document.all.PanelSubHeader.innerHTML = strArray.join("");
	delete strArray;

	strArray = new Array();
	k=0;
	strArray[k++] = "<table width=100% style=\"margin-top:10px;\" cellspacing=0 cellpadding=0>";
	strArray[k++] =	"<tr><td ";
	if (favfolderListLen != 0 || favoriteListLen != 0) 
		strArray[k++] =	"style=\"border-bottom:2px solid #438BCD \" ";
	
	strArray[k++] =		"><table style=\"margin-left:8px;\" cellspacing=0 cellpadding=0 border=0>";
	if (favoriteListLen > 1) 
		strArray[k++] = "<tr><td>Check the boxes next to the favorites you want to move to another folder, and then choose <b>Choose a Folder</b>.</td></tr>";
	else
		strArray[k++] = "<tr><td>Check the box next to the favorite you want to move to another folder, and then choose <b>Choose a Folder</b>.</td></tr>";
	strArray[k++] =	   "<tr><td height=10></td></tr>";
	strArray[k++] =	"</table></td></tr>";

	for (var j = 0; j < favoriteListLen; j++) {
		var xmlFavorite = xmlFavoriteList.item(j);
		var title = xmlFavorite.selectSingleNode("title").text;
		var href = xmlFavorite.selectSingleNode("href").text;
		var id = xmlFavorite.getAttribute("id");
		var lv = xmlFavorite.getAttribute("lv");
		if(xmlFavorite){
			strArray[k++] = "<tr><td height=50 id=\"td" + j + "\" bgColor=transparent style=\"border-bottom:2px solid #438BCD \">";
			strArray[k++] =		"<table height=100% style=\"margin-left:8px;\" cellspacing=0 cellpadding=0 border=0>";
			strArray[k++] =			"<tr><td valign=middle width=20><input type=checkbox ";
			if (j == 0)
				strArray[k++] =	" id=firstBar ";
			else
				strArray[k++] =	" id=\"checkBox"+j+"\" ";
			
			strArray[k++] =		" onClick=\"setMoveArray("+j+")\" nextright=Right";
			strArray[k++] =			"></td><td width=8></td>";
			strArray[k++] =			"<td valign=middle align=center><img style=\"border: 1px solid black;\" width=50 height=35 src=\"";
				
			var thumbNailURL=GetThumbNailURL(xmlFavorite);
			if(thumbNailURL!=null && thumbNailURL!="")
				strArray[k++] = "file:"+thumbNailURL;
			else
				strArray[k++] = "img/fav-default.gif";
			
			strArray[k++] =	"\"></td><td width=6></td>";
			strArray[k++] =	"<td valign=middle><font class=\"titleContent\">"+ cleanFavoriteName(removeTags(title)) + "</font></td></tr>";
			strArray[k++] =	"</table></td></tr>";
		}
	}

	var favCount=0;
	for (var i = 0; i < favfolderListLen; i++) {
		var xmlFavFolder = xmlFavFolderList.item(i);
		var id = xmlFavFolder.getAttribute("id");
		var title = xmlFavFolder.getAttribute("title");
		favCount = xmlFavFolder.selectNodes("favorite").length;
		if (xmlFavFolder) {
			strArray[k++] =	"<tr><td style=\"border-bottom:2px solid #438BCD \">";
			strArray[k++] =		"<table height=50 style=\"margin-left:8px;\" cellspacing=0 cellpadding=0 border=0>";
			strArray[k++] =			"<tr><td valign=middle width=20></td>";
			strArray[k++] =				"<td width=8></td>";
			strArray[k++] =				"<td width=50 height=100% valign=middle align=center><div style=\"width:35px; height:35; border:0;behavior: url(#default#alphaImageLoader); src:img/FavIconFolderOrganize.png;\"></div></td>";
			strArray[k++] =				"<td width=6></td>";
			strArray[k++] =				"<td valign=middle height=100%><font class=\"titleContent\">"+ removeTags(title);
			strArray[k++] =				" <span style=\"font-size:14px;\">(" + favCount;
			strArray[k++] =		")</span></font></td></tr></table></td></tr>";
		}
	}
	
	strArray[k++] = "</table>";
	document.all.leftContent.innerHTML = strArray.join("");
	delete strArray;
	
	strArray = new Array();
	k=0;
	strArray[k++] = "<msntv:CustomButton id=\"Right\" class=\"sidebarButton\" label=\"Choose a Folder\" onClick=\"handleAction(\'moveFavoritesChooseFolder\')\" />";
	strArray[k++] = "<msntv:CustomButton id=\"Cancel\" class=\"sidebarButton\" label=\"Cancel\" onClick='favGoBack();' />";
	document.all.rightMenu.innerHTML = strArray.join("");
	delete strArray;
	strArray = null;
	
	if(document.all.firstBar)
		document.all.firstBar.focus();
	else
		document.all.Cancel.focus();

	g_backFunc = "handleAction(\"organizeFavorites\")";
	
	return true;
}

var folderTitleTextValue = L_NEWFOLDERNAME_TEXT;
function CheckMoveFolderRadioNew(num)
{
	var e = window.event;
	if (e.altKey || e.ctrlKey || e.shiftKey)
		return;
	if(document.all.folderTitleText.value!=folderTitleTextValue){
		document.all.lastBar.checked=true;
		folderTitleTextValue=document.all.folderTitleText.value;
	}
}

function moveToFolderExit()
{
	var rc = callMoveToFolder();
	if (  rc >= 0 ) {
		setTimeout("handleAction('organizeFavorites')",100);
		if ( rc > 0 ){
			var str="Moving ";
			if (numOfMovedFav > 1)
				str +=" favorites";
			else
				str +=" a favorite";
			str+=" to <b>" + targetFolderName +"</b> folder";
			TVShell.PanelManager.AnimationMessageBox(str, "msntv:/Favorites/img/FavMove.gif", "Task_Complete", animationTimeOut);
		}
	}
}

function DrawMoveFavoritesChooseFolder()
{
	document.all.PanelSubHeader.innerHTML = "Move favorites - Choose a Folder";
	
	var parentFolder=findCurrentNode();           
    var folderList = g_oFavXml.selectNodes("//favorites/favfolder");   // all folder nodes
    var folderListLen = folderList.length; 
	var specialLen = 1;//new folder
	if (parentFolder.nodeName != "favorites")
		specialLen++;//root folder
	var favArray = null;
	var indexStr = paramsArray["favoriteIndex"];
	if (indexStr!=null && indexStr!=""){
		favArray= indexStr.split("-");
	}
	numOfMovedFav = favArray.length;
	document.all.scroller.MyDoScroll("scrollToStart");
	
	var num=0;
	var strArray=new Array();
	var j=0;
	strArray[j++] = "<table width=100% style=\"margin-top:10px;\" cellspacing=0 cellpadding=0 border=0>";
	strArray[j++] =	"<tr><td><table style=\"margin-left:8px;\" cellspacing=0 cellpadding=0 border=0>";
	strArray[j++] =	"<tr><td>Choose the folder you want to move the favorite";
	if (favArray.length > 1)
		strArray[j++] ="s";
	
	strArray[j++] = " to, and then choose <b>Continue</b>. To create a new folder, type the name in the box at the bottom of the list.</td></tr>";
	strArray[j++] =	"<tr><td height=10></td></tr>";
	strArray[j++] = "</table></td></tr>";

	var indentRow = "";
	if(parentFolder.nodeName != "favorites"){
		strArray[j++] =		"<tr><td><table height=24 width=100% cellspacing=0 cellpadding=0 border=0 style=\"margin-left:8px;\">";
		strArray[j++] =				"<tr><td valign=middle align=center><input id=firstBar type=radio name=ChooseMoveFolderRadio nextright=Right checked></td>";
		strArray[j++] =					"<td width=6></td><td><font class=\"titleContent\">Main folder</font></td></tr>";
		strArray[j++] =				"</table></td></tr>";
		strArray[j++] =		"<tr><td height=3></td></tr>";
		indentRow = "<td width=15></td>";
		num++;
	}

	var favCount=0;
    // go thru each folder item
	for (var i = num; i < folderListLen + specialLen-1; i++) {
		var folder = folderList.item(i-specialLen+1);
		var title = folder.getAttribute("title");
		var id = folder.getAttribute("id");
		favCount = folder.selectNodes("favorite").length;
		if (folder.getAttribute("id") != parentFolder.getAttribute("id")) {
			strArray[j++] =	"<tr><td><table height=24 width=100% cellspacing=0 cellpadding=0 border=0 style=\"margin-left:8px;\">";
			strArray[j++] =	"<tr>" + indentRow;
			strArray[j++] =		"<td valign=middle align=center><input type=radio name=ChooseMoveFolderRadio nextright=Right ";
			if(i == 0) 
				strArray[j++] = " id=firstBar checked";
			else
				strArray[j++] = " id=\"radio"+i+"\" ";

			strArray[j++] =	"></td><td width=6></td><td><font class=\"addFavFolderTitleContent\">";
			strArray[j++] =	removeTags(title) +" <span style=\"font-size:14px;\">(";
			strArray[j++] = 	favCount + ")</span></font></td></tr></table></td></tr>";
			strArray[j++] =	"<tr><td height=3></td></tr>";
			num++;
		}
	}
	
	strArray[j++] =	"<tr><td><table height=30 width=100% cellspacing=0 cellpadding=0 border=0 style=\"margin-left:8px;\">";
	strArray[j++] =				"<tr>" + indentRow;
	strArray[j++] =						"<td valign=middle align=center><input type=radio name=ChooseMoveFolderRadio id=lastBar ";
	if (num ==0)
		strArray[j++] = " checked ";
	strArray[j++] =				"></td><td width=6></td><td>New folder:</td><td width=5></td>";
	strArray[j++] =				"<td align=right><input id=folderTitleText class=\"inputText\" onKeyUp=\"CheckMoveFolderRadioNew("+num+")\" nextright=Right type=text size=19 maxlength=242 value=\"";
	strArray[j++] =					L_NEWFOLDERNAME_TEXT +"\"></td><td width=8></td></tr>";
	strArray[j++] =				"</table></td></tr>";
	strArray[j++] =	"<tr><td height=3></td></tr>";
	num++;

	strArray[j++] = "	</table>";
	document.all.leftContent.innerHTML = strArray.join("");
	delete strArray;

	strArray=new Array();
	j=0;
	strArray[j++] = "<msntv:CustomButton id=\"Right\" class=\"sidebarButton\" label=\"Continue\" onClick='moveToFolderExit();' />";
	strArray[j++] = "<msntv:CustomButton id=\"Cancel\" class=\"sidebarButton\" label=\"Cancel\" onClick='favGoBack();' />";
	document.all.rightMenu.innerHTML = strArray.join("");
	delete strArray;
	strArray=null;
	
	if(document.all.firstBar)
		document.all.firstBar.focus();
	else
		document.all.Cancel.focus();

	g_backFunc = "handleAction( \"moveFavorites\")";
	
}

function DrawShortcuts()
{
	document.all.PanelSubHeader.innerHTML = "Favorites shortcuts";
	document.all.scroller.MyDoScroll("scrollToStart");
	var shortcutFavList = new Array (NumOfShortcuts);
	var shortcutNum = 0;
	for (var i = 0; i < NumOfShortcuts; i++) {
		var shortcutValue = 'F' + (i+1);
		var propbagNode = g_oFavXml.selectSingleNode("//(propbag)[@sect = 'MSNTV-SHORTCUT'][@val ='" + shortcutValue + "']"); 
		if (propbagNode) {
			shortcutNum ++;
			shortcutFavList[i] = propbagNode.parentNode;
			// == favoriteNode.selectSingleNode("href").text;
		}else
			shortcutFavList[i] = null;
	}
	
	var strArray=new Array();
	var j=0;
	
	strArray[j++]	 = "<table width=100% valign=top cellspacing=0 cellpadding=0 border=0 style=\"margin-top:10px;\">";
	strArray[j++]	 = "<tr><td><table cellspacing=0 cellpadding=0 border=0 style=\"margin-left:8px;\">";
	if (shortcutNum > 0) {
		strArray[j++]	 =	"<tr><td>You have the following favorites shortcut";
		if (shortcutNum > 1)
			strArray[j++] = "s";
		
		strArray[j++]	 =	" set:</td></tr><tr><td height=10></td></tr>";
		for (var i = 0; i < NumOfShortcuts; i++) {
			if (shortcutFavList[i] != null) {
				strArray[j++] = "<tr><td width=350><font style=\"word-wrap:break-word;\"><b>Fav # "+ (i+1) +"</b>: ";
				strArray[j++] = removeTags(shortcutFavList[i].selectSingleNode("title").text) + "</font></td></tr>";
			}
		}
		
		strArray[j++] =		"<tr><td height = 15></td></tr>";
		strArray[j++] =		"<tr><td>To set up another shortcut, go to a Web page, and then press one of the <b>Fav #</b> keys on your keyboard. You can then use that <b>Fav #</b> key to return to the Web page at any time.</td></tr>";
	} else {
		strArray[j++] =		"<tr><td>You can use the <b>Fav #1, #2, and #3</b> keys on your keyboard as shortcuts to the favorites you visit most frequently. After you set up a shortcut for a <b>Fav #</b> key, you can use that key to go directly to one of your favorites.</td></tr>";
		strArray[j++] =		"<tr><td height = 15></td></tr>";
		strArray[j++] =		"<tr><td>To set up a shortcut, go to a Web page, and then press one of the <b>Fav #</b> keys on your keyboard. You can then use that <b>Fav #</b> key to return to the Web page at any time.</td></tr>";
	}
	strArray[j++] =			"</table></td></tr></table>";
	document.all.leftContent.innerHTML=strArray.join("");
	delete strArray;
	strArray=null;
	delete shortcutFavList;
	shortcutFavList=null;

	document.all.rightMenu.innerHTML="<msntv:CustomButton id=\"Done\" class=\"sidebarButton\" label=\"Done\" onClick='favGoBack();' />";	

	document.all.Done.focus();

	g_backFunc = "handleAction(\"showRootFavorites\")";
	
}


function hasFolder( fldLen)
{
	if ( paramsArray["folder"]==null  || paramsArray["folder"] == "" )
		return fldLen;
	else
		return 0;
}


function DrawShowFavorites()
{
	var node = findCurrentNode();
	var xmlFavFolderList = node.selectNodes("favfolder");
	var favfolderListLen = hasFolder(xmlFavFolderList.length);
	var xmlFavoriteList = node.selectNodes("favorite");
	var favoriteListLen = xmlFavoriteList.length;
	var strArray=null;
	var i=0;

	document.all.scroller.MyDoScroll("scrollToStart");
	strArray = new Array();
	if (node.nodeName == "favorites") {
		strArray[i++] = "<font class=subHeader>Main folder for <b>";
		strArray[i++] = removeTags(TVShell.UserManager.CurrentUser.Name); 
		strArray[i++] = "</b></font>";
	}else{
		strArray[i++] = "<table cellspacing=0 cellpadding=0 border=0>";
		strArray[i++] =		"<tr><td><div style=\"padding:0px; height:35px; width:35px; border:0; behavior: url(#default#alphaImageLoader); src:img/FavIconFolderHeader.png;\"></div></td>";
		strArray[i++] =			"<td width=8></td><td><font class=subHeader>";
		strArray[i++] =  				removeTags(node.getAttribute("title"));
		strArray[i++] =  "</font></td></tr></table>";
	}
	document.all.PanelSubHeader.innerHTML = strArray.join("");
	delete strArray;
	strArray=null;

	strArray = new Array();
	i=0;
			
	strArray[i++] = "<table style=\"margin-top:10px;\" width=100% valign=top cellspacing=0 cellpadding=0><tr><td ";
	
	if (favfolderListLen != 0 || favoriteListLen != 0) 
		strArray[i++] = "style=\"border-bottom:2px solid #438BCD \" ";
	
	strArray[i++]  +=	"><table cellspacing=0 cellpadding=0 border=0 style=\"margin-left:8px;\">";
	
	if (favfolderListLen == 0 && favoriteListLen == 0) {
		// if we've got no nodes, figure out how deep we are and             
		// tell the user they have no favorites or just none in this folder  
		if (node.nodeName == "favorites") {
			strArray[i++] = "<tr><td>You don\'t have any favorites saved. Favorites are Web pages you visit frequently and want to return to.</td></tr>";
			strArray[i++] =  "<tr><td height=10></td></tr>";
			strArray[i++] =  "<tr><td>To save a Web page as a favorite, go to the page, and then press the <b>Save Fav</b> key on your keyboard.</td></tr>";
			strArray[i++] =  "<tr><td height=10></td></tr>";
			strArray[i++] =  "<tr><td>To learn more about using Favorites, choose this link:</td></tr>";
			strArray[i++] =  "<tr><td height=10></td></tr>";
			strArray[i++] =  "<tr><td><table cellspacing=0 cellpadding=0 border=0>";
			strArray[i++] =				"<tr><td><span style=\"padding:0px; height:14px; width:7px; behavior:url(#default#alphaImageLoader); src:../images/bulletcustom.png;\"></span></td>";
			strArray[i++] =					"<td width=5></td><td><a tabindex=0 onclick=\"ShowHelp(GetPaneHelpURL(PH_topicTOC, 'MSNTV_TRS_TOC_Favs.htm', 'FavoritesOverView'))\">Favorites Overview</a></td></tr>";
			strArray[i++] =			"</table></td></tr>";
		} else {
			strArray[i++] = "<tr><td>You don\'t have any favorites saved in this folder.</td></tr>";
			strArray[i++] =  "<tr><td height=10></td></tr>";
			strArray[i++] =  "<tr><td>To learn more about saving or moving favorites to this folder, choose this link:</td></tr>";
			strArray[i++] =  "<tr><td height=10></td></tr>";
			strArray[i++] =  "<tr><td><a tabindex=0>";
			strArray[i++] =  "<tr><td><table cellspacing=0 cellpadding=0 border=0>";
			strArray[i++] =				"<tr><td><span style=\"padding:0px; height:14px; width:7px; behavior:url(#default#alphaImageLoader); src:../images/bulletcustom.png;\"></span></td>";
			strArray[i++] =					"<td width=5></td><td><a tabindex=0 onclick=\"ShowHelp(GetPaneHelpURL(PH_topicTOC, 'MSNTV_TRS_TOC_Favs.htm', 'FoldersOverview'))\">Folders Overview</a></td></tr>";
			strArray[i++] =			"</table></td></tr>";
		}
	} else {
		if (node.nodeName == "favorites") {
			if (favfolderListLen >0 && favoriteListLen>0)
				strArray[i++] = "<tr><td>Choose a folder to see its contents, or choose a favorite to go directly to it.</td></tr>";
			else if (favfolderListLen > 0)
				strArray[i++] = "<tr><td>Choose a folder to see its contents.</td></tr>";
			else if (favoriteListLen > 0)
				strArray[i++] = "<tr><td>Choose a favorite to go directly to it.</td></tr>";
		} else {
			strArray[i++] = "<tr><td>Choose a favorite to go directly to it.</td></tr>";
		}	
	}
	strArray[i++] =		"<tr><td height=10></td></tr>";
	strArray[i++] = 	"</table></td></tr>";
	
	for (var j = 0; j < favoriteListLen; j++) {
		var xmlFavorite = xmlFavoriteList.item(j);
		var title = xmlFavorite.selectSingleNode("title").text;
		var href = xmlFavorite.selectSingleNode("href").text;
		var id = xmlFavorite.getAttribute("id");
		var lv = xmlFavorite.getAttribute("lv");
		if (xmlFavorite) {
			strArray[i++] = "<tr><td style=\"border-bottom:2px solid #438BCD \"><a onClick=\"handleAction(\'navigate\')\" onmousedown=\"handleMouse(this.clk_id)\" tabindex=0 clk_id=\"" + id + "\" ";
			if (j == 0)
				strArray[i++] =" id=firstBar ";
			else  
				strArray[i++] =" id=\"open" + id + "\" ";
			strArray[i++] =	"><table width=100% height=84 cellspacing=0 cellpadding=0 border=0>";
			strArray[i++] =		"<tr><td width=8></td>";
			strArray[i++] =		"<td width=96 valign=middle align=center><img style=\"width:96px; height:66px; border:1px solid black;\" src=\"";
				
			var thumbNailURL=GetThumbNailURL(xmlFavorite);
			if(thumbNailURL!=null && thumbNailURL!="")
				strArray[i++] ="file:"+thumbNailURL;
			else
				strArray[i++] = "img/fav-default.gif";
			
			strArray[i++] =		"\"></td><td width=6></td>";
			strArray[i++] =			"<td><span class=\"titleContent\">" + cleanFavoriteName(removeTags(title)) + "</span><br>";
			strArray[i++] =				"<span class=\"hrefContent\">"+ removeTags(href) + "</span></td></tr>";
			strArray[i++] =	"</table></a></td></tr>";
		}
	}
	
	var favCount=0;
	for (var j = 0; j < favfolderListLen; j++) {
		var xmlFavFolder = xmlFavFolderList.item(j);
		var id = xmlFavFolder.getAttribute("id");
		var title = xmlFavFolder.getAttribute("title");
		favCount = xmlFavFolder.selectNodes("favorite").length;
		if (xmlFavFolder) {
			strArray[i++] =	"<tr><td style=\"border-bottom:2px solid #438BCD \"><a onClick=\"handleAction(\'display\')\" onmousedown=\"handleMouse(this.clk_id)\" tabindex=0 clk_id=\"" + id + "\"";			
			if (favoriteListLen + j == 0)
				strArray[i++] = " id=firstBar";
			else  
				strArray[i++] = " id=\"open" + id + "\" ";
			
			strArray[i++] =	"><table width=100% height=40 cellspacing=0 cellpadding=0 border=0>";
			strArray[i++] =		"<tr><td width=8></td>";
			strArray[i++] =		"<td width=96 valign=middle align=center><div style=\"padding:0px; height:40px; width:40px; border:0; behavior: url(#default#alphaImageLoader); src:img/FavIconFolderList.png;\"></div></td>";
			strArray[i++] =		"<td width=6></td><td ><span class=\"titleContent\">";
			strArray[i++] =		 	removeTags(title) + " <span style=\"font-size:14px;\">(";
			strArray[i++] =			favCount + ")</span></span></td></tr>";
			strArray[i++] =		"</table></a></td></tr>";
		}
	}

	strArray[i++] = "</table>";
	document.all.leftContent.innerHTML=strArray.join("");
	delete strArray;
	strArray=null;

	strArray = new Array();
	i=0;

	if(favoriteListLen > 0 && node.nodeName != "favorites"){
		strArray[i++] = "<msntv:CustomButton id=\"Organize_ShowFavorites\" class=\"sidebarButton\" label=\"Organize Folder\" onClick=\"handleAction(\'organizeFavorites\')\" />";
	}
	if (node.nodeName == "favorites") {
		strArray[i++] = "<msntv:CustomButton id=\"Organize_ShowFavorites\" class=\"sidebarButton\" label=\"Organize\" onClick=\"handleAction(\'organizeFavorites\')\" />";
		strArray[i++] = "<msntv:CustomButton id=\"Shortcut\" class=\"sidebarButton\" label=\"Shortcuts\" onClick=\"handleAction(\'shortcuts\')\" />";
	}
	var doneAction = "dismissPanel";
	if ( paramsArray["folder"] && paramsArray["folder"] != "" )
		doneAction = "showRootFavorites";
	strArray[i++] = "<msntv:CustomButton id=\"Done\" class=\"sidebarButton\" label=\"Done\" onClick='favGoBack();' />";
	document.all.rightMenu.innerHTML= strArray.join("");
	delete strArray;
	strArray=null;

	if ( g_prevFolderID && g_prevFolderID != "" ){
		var obj = document.getElementById( "open" + g_prevFolderID );
		if ( obj )
			obj.focus();
		else
			document.all.Done.focus();			
	} 
	else {
		if(document.all.firstBar)
			document.all.firstBar.focus();
		else
			document.all.Done.focus();
	}

	g_backFunc = "handleAction(\"" + doneAction + "\")";
	
}

function gotoSync()
{
	thisPanel.GotoURL("msntv:/Favorites/FavoritesSync.html?timeout=100");
}

function favGoBack()
{
	if ( g_backFunc && g_backFunc != "" )
		eval(g_backFunc);
	else
		PanelManager.Hide(window.name);
}

function ShowHelp( url )
{
	var pStr = "favoritespanel?" + thisPanel.URL;
	TVShell.PanelManager.Item("main").SetTravelLogFlag( "openpanel" , pStr );
	ShowMainPanelWithURL( url );
}

function ShowMainPanelWithURL(URL)
{
	PanelManager.Show('main');
	if (PanelManager.FocusedPanel.Name == 'favoritespanel') {
        g_fPending=true;
        g_pendingURL=URL;

	} else {
        PanelManager.Item('main').GotoURL(URL);
	}
}

function UpdateThumbnail()
{
	var sPath = "//favorite[@id = '" + escapeString(navigateID) + "']";
	var oNode = g_oFavXml.selectSingleNode(sPath);
	if (null != oNode) {
		var href = oNode.selectSingleNode("href").text;
		var pcwszUrl = GetTargetPanelURL();
		if (href == pcwszUrl){
			g_favoritesMgr.navigate(oNode, GetCurrentThumbnailURL());
			SaveFavorites();
		}
	}
	navigateID="";
	var sLocation = thisPanel.URL;
	if( sLocation.indexOf("?")>0 || g_NeedReload)
		thisPanel.GotoURL(sLocation.substr(0,(sLocation.indexOf("?")>0)?sLocation.indexOf("?"):sLocation.length));

}

function OnCapture()
{
	if (navigateID != "") {
		UpdateThumbnail();
		if ( TVShell.UserManager.CurrentUser.FavoritesCount > MAX_RECENT_THUMBNAILS )
			g_favoritesMgr.saveMostRecentThumbNails(MAX_RECENT_THUMBNAILS);
	}
}  

function OnAfterHide(name)
{
	if (name == "favoritespanel") {
		TVShell.Message("onAfterHide " + name + " navigateID: " + navigateID);
		var sLocation = thisPanel.URL;
		if(g_fPending){
			g_fPending=false;
			var URL= g_pendingURL;
			g_pendingURL="";
			PanelManager.Item('main').GotoURL(URL);
		}
		if (navigateID == "" && ( sLocation.indexOf("?")>0 || g_NeedReload)){
			var theURL = sLocation.substr(0,(sLocation.indexOf("?")>0)?sLocation.indexOf("?"):sLocation.length);
			setTimeout("thisPanel.GotoURL(\""+ theURL + "\");",1000);
		}
	}
}

var shortCutKeyCode = 0;
var numOfShortcutKeyDown = 0;
var halfKeyDownCountTimerID = 0;
var fullKeyDownCountTimerID = 0;
var shortcutKeyNum = 0;

function OnServiceListKeyDown(ServiceEntry)
{
	if (!TVShell.IsOn || !TVShell.UserManager.CurrentUser.IsAuthorized)
		return;
	//
	// Check if the current panel is marked "modal", in which case we leave it alone.
	//
	var CurrentPanel = TVShell.PanelManager.FocusedPanel;
	var Modal = false;
	if (CurrentPanel && CurrentPanel.Modal)
		Modal = true;
	if (!Modal) {
		// If the entry is a favorite's shortcut, then set a timer 
		//
		if (ServiceEntry.name.substr(0,ServiceEntry.name.length-1) == "favorite::shortcut") {
			TVShell.Message("Favorites.html: shortcut keydown: keycode="+ServiceEntry.KeyCode);
			var currentDate = new Date();
			if (shortCutKeyCode == 0) {
				halfKeyDownCountTimerID = setTimeout("CheckHalfKeyDownCount()", 1800);
				fullKeyDownCountTimerID = setTimeout("CheckFullKeyDownCount()", 3000);
				shortCutKeyCode = ServiceEntry.KeyCode;
				shortcutKeyNum = ServiceEntry.name.charAt(ServiceEntry.name.length-1);
				numOfShortcutKeyDown = 1;
			} else if (shortCutKeyCode == ServiceEntry.KeyCode) {
				numOfShortcutKeyDown ++;
			} else {
				clearTimeout(halfKeyDownCountTimerID);
				clearTimeout(fullKeyDownCountTimerID);
				halfKeyDownCountTimerID = setTimeout("CheckHalfKeyDownCount()", 1800);
				fullKeyDownCountTimerID = setTimeout("CheckFullKeyDownCount()", 3000);
				shortCutKeyCode = ServiceEntry.KeyCode;
				shortcutKeyNum = ServiceEntry.name.charAt(ServiceEntry.name.length-1);
				numOfShortcutKeyDown = 1;
			}
		}
		else if ( PanelManager.FocusedPanel.Name == "favoritespanel" ){
			switch( ServiceEntry.name ){
				case  "browser::back":
					favGoBack();
					break;
				case "browser::esc":
					PanelManager.Hide(window.name);
					break;
			}
		}
	}
}

function CheckHalfKeyDownCount()
{
	TVShell.Message("favorites.html CheckHalfKeyDownCount numOfShortcutKeyDown ="+numOfShortcutKeyDown);
	var shortcutValue = 'F'+ shortcutKeyNum;
	if (numOfShortcutKeyDown < 2) {

		clearTimeout(fullKeyDownCountTimerID);
		numOfShortcutKeyDown = 0;
		shortCutKeyCode = 0;

		var propbagNode = g_oFavXml.selectSingleNode("//(propbag)[@sect = 'MSNTV-SHORTCUT'][@val ='" + shortcutValue + "']"); 
		// directly go to the favorite URL
		TVShell.Message("Favorites.html: directly go to the favorite URL shortcutValue="+ shortcutValue);
		if (propbagNode) {
			var favoriteNode = propbagNode.parentNode;
			var href = favoriteNode.selectSingleNode("href").text;
			TVShell.Message("Favorites.html: href=" + href);
			ShowMainPanelWithURL(href);
		} else {
			AssignNewShortcut();
		} 
	}
}

function CheckFullKeyDownCount()
{
	TVShell.Message("favorites.html CheckFullKeyDownCount numOfShortcutKeyDown ="+numOfShortcutKeyDown);
	if (numOfShortcutKeyDown <= 1) 
		return;
	var shortcutValue = 'F'+ shortcutKeyNum;
	var propbagNode = g_oFavXml.selectSingleNode("//(propbag)[@sect = 'MSNTV-SHORTCUT'][@val ='" + shortcutValue + "']"); 
	var title, href, favoriteNode;
	
	if (numOfShortcutKeyDown <= 5) {
		shortCutKeyCode = 0;
		numOfShortcutKeyDown = 0;

		// directly go to the favorite URL
		if (propbagNode) {
			favoriteNode = propbagNode.parentNode;
			href = favoriteNode.selectSingleNode("href").text;
			TVShell.Message("Favorites.html: href=" + href);
			ShowMainPanelWithURL(href);
		} else {
			AssignNewShortcut();
		} 
	} else {
		shortCutKeyCode = 0;
		numOfShortcutKeyDown = 0;

		// assign the main panel URL to this shortcut key
		TVShell.Message("Favorites.html: assign new URL to this shortcut key");
		if (propbagNode) {
			favoriteNode = propbagNode.parentNode;
			title = favoriteNode.selectSingleNode("title").text;
			href = favoriteNode.selectSingleNode("href").text;
			if (href == GetTargetPanelURL()) {
				var str ="<b>Fav # " + shortcutKeyNum + "</b> shortcut has been set.";
				TVShell.PanelManager.AnimationMessageBox(str, "msntv:/Panels/Images/TaskCompleted.gif", "Task_Complete", animationTimeOut);
			} else {
				ReassignShortcut(favoriteNode);
			}
		} else {
				AssignNewShortcut();
		}
	}
}

function AssignNewShortcut()
{
	var shortcutValue = 'F'+ shortcutKeyNum;
	var str ="To set up the <b>Fav # "+ shortcutKeyNum +"</b> key as a shortcut to <b>";
	var sFavoriteNameBase = getDocumentTitle();
	str += removeTags(sFavoriteNameBase) + "</b>, choose <b>Set Shortcut</b>. <br><br>You can then return to <b>"+removeTags(sFavoriteNameBase)+"</b> at any time by pressing <b>Fav # "+ shortcutKeyNum +"</b> on your keyboard.";
	var chooseResult =  TVShell.PanelManager.CustomMessageBox(str,"", "Set Shortcut;Cancel", 0,"", 1, MGX_ICON_INFO, MGX_SIZE_LARGE);
	if (!chooseResult) {
		var favoriteList =  g_oFavXml.selectNodes("/favorites/favorite");
		var theNode = searchFavorites(favoriteList, sFavoriteNameBase,false);
		var favID;
		if ( theNode != null )
			favID = theNode.getAttribute("id");
		else{
			if ( syncOK() )				
				favID = callCreateFavorite(0);
		}
		if (favID != null) {
			var favNode = g_oFavXml.selectSingleNode("//(favorite)[@id = '" + escapeString(favID) + "']");
			if (favNode)
				g_favoritesMgr.newShortcut(favNode,shortcutValue);
			str ="<b>Fav # " + shortcutKeyNum + "</b> shortcut has been set.";
			TVShell.PanelManager.AnimationMessageBox(str, "msntv:/Panels/Images/TaskCompleted.gif", "Task_Complete", animationTimeOut);
			SaveFavorites();
			if ( theNode == null )
				setTimeout("handleAction('showRootFavorites');",100);
		}
	}
}

function ReassignShortcut(favoriteNode)
{
	var shortcutValue = 'F'+ shortcutKeyNum;
	var title = favoriteNode.selectSingleNode("title").text;
	var str ="The <b>Fav # " + shortcutKeyNum + "</b> key is currently set up as a shortcut to <b>"+ removeTags(title) + "</b>."
		   + "<br><br>To set up the <b>Fav # " + shortcutKeyNum + "</b> key as a shortcut to <b>";
	var sFavoriteNameBase = getDocumentTitle();
	str += removeTags(sFavoriteNameBase) + "</b> instead, choose <b>Change Shortcut</b>. To keep it as it is right now, choose <b>Cancel</b>."; 
	var chooseResult =  TVShell.PanelManager.CustomMessageBox(str,"", "Change Shortcut;Cancel", 0,"", 1, MGX_ICON_INFO, MGX_SIZE_LARGE);
	if (!chooseResult) {
		g_favoritesMgr.deleteShortcut(favoriteNode,shortcutValue);
		var favoriteList =  g_oFavXml.selectNodes("/favorites/favorite");
		var theNode = searchFavorites(favoriteList, sFavoriteNameBase,false);
		var favID;
		if ( theNode != null )
			favID = theNode.getAttribute("id");
		else{
			if ( syncOK() )
				favID = callCreateFavorite(0);
		}
		if (favID != null) {
			var favNode = g_oFavXml.selectSingleNode("//(favorite)[@id = '" + escapeString(favID) + "']");
			g_favoritesMgr.newShortcut(favNode , shortcutValue);
			str ="<b>Fav # " + shortcutKeyNum + "</b> shortcut has been set.";
			TVShell.PanelManager.AnimationMessageBox(str, "msntv:/Panels/Images/TaskCompleted.gif", "Task_Complete", animationTimeOut);
			SaveFavorites();
			if ( theNode == null )
				setTimeout("handleAction('showRootFavorites');",100);
		}
	}
}


function OnFavoritesChanged(hr)
{
	if (hr ==0) {
//		init();
	}
}


function OnBeforeShow(name)
{
  if ( name == "favoritespanel")
  {
    var popupPanel=null;
	var showingPopup=false;
	showingPopup = (popupPanel=PanelManager.Item("popuppanel")) && popupPanel.State == 0;
	if(showingPopup)
	 TVShell.PanelManager.Item("shell").Document.parentWindow.CapturePopupThumbnail();
  }
}


Sink.AttachEvent(TVShell.LoginManager, "IDCRLOnAuthStateChanged",IDCRLOnAuthStateChanged);
Sink.AttachEvent(TVShell,		"OnServiceListKeyDown",	OnServiceListKeyDown);
Sink.AttachEvent(TVShell.ThumbnailManager,	"OnCapture",	OnCapture);
Sink.AttachEvent(PanelManager,	"OnBeforeShow",			OnBeforeShow);
Sink.AttachEvent(PanelManager,	"OnAfterHide",			OnAfterHide);
Sink.AttachEvent(g_favoritesMgr,	"OnFavoritesChanged",	OnFavoritesChanged);


</script>
</head>
<body style="behavior:none;margin:0px;">
 <div style="width:100%;height:100%;behavior: url(../HTC/PanelBG.htc);">
	<div style="width:100%;height:100%;padding:15px;">
	<table class="contentText" style="width:100%; height:100%;"  cellspacing=0 cellpadding=0 border=0>
		<tr><td class="heading" height=30>
<script>
var helpURL = GetPaneHelpURL(PH_topicTOC,'MSNTV_TRS_TOC_Favs.htm');
document.write("<msntv:PanelHeading id=\"PanelHeader\" label=\"Favorites\" helpURL=\""+ helpURL + "\" />");
</script>
			</td></tr>
		<tr><td height=35 align="left">
				<div id="PanelSubHeader" style="padding:0px 0px 0px 8px;"></div>
			</td></tr>
		<tr><td class="topGradient" style="height:1px;"></td></tr>
		<tr><td height=100%>
				<table width=100% height=100% cellspacing=0 cellpadding=0 border=0>
					<tr><td class="content" style="width:73%; vertical-align:top;">
							<div id="scroller" typeToScroll="true" assumeEverythingsVisible="true" class="scroller" tabindex=0 style="padding:0px 24px 0px 0px;">
								<div id="leftContent"></div>
							</div></td>
						<td class="sidebar" style="width:27%; vertical-align:top; padding:9px 0px 0px 6px;">
							<div id="rightMenu"></div></td></tr>
				</table></td></tr>
	</table>
		</div>
	</div>
	<script>
        setTimeout("init();",10);
	</script>
</body>
<script>
function IsMSNTVScalingEnabled() { return false; }
SetMSNTVScale();
</script>
</html>
