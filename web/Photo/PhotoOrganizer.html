<html xmlns:msntv>
<?import namespace="msntv" implementation="../HTC/CustomButton.htc">
<?import namespace="msntv" implementation="../HTC/ScrollingDIV.htc">
<?import namespace="msntv" implementation="../HTC/PhotoHeading.htc">
<?import namespace="msntv" implementation="../HTC/FolderOrganizer.htc">
<?IMPORT namespace="msntv" implementation="../HTC/SlideShow.htc">


<head>
<title>Album Organizer</title>

<link rel=StyleSheet type="text/css" href="../css/Base.css">
<link rel=StyleSheet type="text/css" href="../css/Photo.css">


<script LANGUAGE=Javascript SRC="../Javascript/TVShell.js"></script>
<SCRIPT LANGUAGE=Javascript SRC="msntv:/msntv_progress_loc.js"></SCRIPT>
<script LANGUAGE=Javascript SRC="../Javascript/ProgressPanel.js"></script>
<SCRIPT language="Javascript" src="../Javascript/Panels.js"></SCRIPT>
<SCRIPT language="Javascript" src="../Javascript/parameters.js"></SCRIPT>
<SCRIPT language="Javascript" src="../Javascript/ContentPaneHelp.js"></SCRIPT>
<script language="Javascript" src="msntv:/Javascript/DMRCommon.js"></script>
<script language="Javascript" src="msntv:/Javascript/DMREnumerate.js"></script>
<SCRIPT language="Javascript" src="../photo/Photos.js"></SCRIPT>
<SCRIPT language="Javascript" src="msntv:/photo/PhotoSOAP.js"></SCRIPT>
<SCRIPT language="Javascript" src="msntv:/Javascript/ServiceList.js"></SCRIPT>
<SCRIPT language="Javascript" src="msntv:/Javascript/DiplomaSettings.js"></SCRIPT>

<style>
	
	.infoArea
	{
		position: absolute;
		top: 56px;
		left: 0px;
		padding-left: 0px;
		padding-right: 0px;
		overflow: hidden;
		startColor:#B2B2B2;
		endcolor: #EBEBEB;
		angle:0;
	}
					

</style>
	

<script language="Javascript">


var StorageDevice ;


var LOCAL =1;  // 1---- local 
var ONLINE =2; // 2---- online

var g_StorageType=0; // no storage
var g_HTTPSource = false; // pictures are HTTP sources (other than UNC sources)

SetProgressText("Please wait a moment...");
SetProgressStopFunction(StopProgress)
ShowProgressPanel();
SetProgressPercent(20);


var g_SlideshowHTC;
var FirstItems = new Array()
var g_fLoading=true;

if(parameters["sourcetype"] && parameters["sourcetype"]=="http")
    g_HTTPSource = true;

 switch(parameters["storage"])
 {
	case "local": 
		StorageDevice = FindStorageDevice(userDataVolumeName);
		g_StorageType = LOCAL;
	    break;
	case "online":
        g_StorageType = ONLINE;
        
        var spaceAlias = parameters["alias"];

		StorageDevice = GetOnlineStorageDevice(spaceAlias);
		if(!StorageDevice)
		{
		    var entry = TVShell.ActiveServiceList("onlinestorage::root");
		    if(entry && HomeNetworkObj)
	//		if(HomeNetworkObj)
		    {
		        HomeNetworkObj.AttachOnlineStorage(spaceAlias, entry.URL, true);
		        //HomeNetworkObj.AttachOnlineStorage(spaceAlias, "", true);
		        StorageDevice = GetOnlineStorageDevice(spaceAlias);
		    }
		}
	    break;
	default:
		StorageDevice=null;
	    break;
 }  


XMLFileURL = parameters.XMLFileURL;

var oldDescriptionHTML="";
var oldTipHTML="";

var gFolderIconURL="msntv:/photo/assets/PhotoAlbum.png";

var BOSPhotoCount = 0;
var savedPhotoCount = 0;
var checkedList=new Array();

var IMAGE_DOWNLOAD_TIMEOUT = 5 * 60 * 1000;
var tempImage = new Image();
var destPath="";
var destName="";
var destPermission="";

var nameConvention="An album name can have letters (A-Z, a-z), spaces, and numbers only, and cannot be more than 30 characters long.";
var oldScreensaver="";

var Sink=new ActiveXObject("MSNTV.MultipleEventSink");

Sink.AttachEvent(PhotoManager, "OnThumbnailReady"   , OnAlbumThumbnailReady);

var ThumbnailIndexMap = new Array();

function OnAlbumThumbnailReady(imgSrcURL, opStatus)
{
  var pos=ThumbnailIndexMap[imgSrcURL];
  if(pos && pos>=0 && pos <100)
  {
   var curThumbnailID="imgThumbnail"+pos;
   if(document.all[curThumbnailID])
       document.all[curThumbnailID].src="file://"+PhotoManager.GetThumbnailImageURL(imgSrcURL);
  }
}

function ValidateName(newName) 
{

   var result=false;
   var i=0;
   if(newName)
   {
     var length=newName.length;
     for(i=0;i<length;i++)
     {
        if(!IsValidChar(newName.charCodeAt(i)))
          return false;
      }
      
	  result=true;
   }
   
   return result;
}

function ConfirmDelete(item, multiSelection) 
{
  var result=0;
  var info="Are you sure you want to delete <em>"+item+"</em> and the photos in it?";

  if(multiSelection)
  {
    result=TVShell.PanelManager.CustomMessageBox(info,"","OK;Yes to All;Cancel",2,"", true);
    if(result <= 1)
	TVShell.EventLog.Usage("photo","action=AlbumDeleted");
  }
  else
  {
    result=TVShell.PanelManager.CustomMessageBox(info,"","OK;Cancel",1,"", true);
    if(result == 0)
	TVShell.EventLog.Usage("photo","action=AlbumDeleted");
  }

   return result;
}

var charCodeOfCapA="A".charCodeAt(0); 
var charCodeOfA="a".charCodeAt(0);
var charCodeOfCapZ="Z".charCodeAt(0);
var charCodeOfZ="z".charCodeAt(0);
var charCodeOfNine="9".charCodeAt(0);
var charCodeOfZero="0".charCodeAt(0);
var charCodeOfSpace=" ".charCodeAt(0);

function IsValidChar(code)
{
   if(code>=charCodeOfCapA&&code<=charCodeOfCapZ)
     return true;
   else if(code>=charCodeOfA&&code<=charCodeOfZ)
     return true;
   else if(code>=charCodeOfZero&&code<=charCodeOfNine)
     return true;
   else if(code==charCodeOfSpace)
     return true;
   else 
     return false;
}


function CreateContent()
{   
    PhotoFolderOrganizer.onClickBtn=OnClickBtn;
    
    PhotoFolderOrganizer.onClickItem=OnClickItem;
    PhotoFolderOrganizer.onFolderFocusIn=OnFolderFocusIn;
    PhotoFolderOrganizer.onFolderFocusOut=OnFolderFocusOut;
    PhotoFolderOrganizer.onAddComplete=OnAddComplete;
    PhotoFolderOrganizer.onRenameOneComplete=OnRenameOneComplete;
    PhotoFolderOrganizer.onRenameComplete=OnRenameComplete;
    PhotoFolderOrganizer.onDeleteOneComplete=OnDeleteOneComplete;
    PhotoFolderOrganizer.onDeleteComplete=OnDeleteComplete;
    PhotoFolderOrganizer.onNoItemSelected=OnNoItemSelected;
    PhotoFolderOrganizer.onBuildComplete=OnAlbumsBuildCompleted;
    
	PhotoFolderOrganizer.onInvalidName=OnInvalidName;    
    PhotoFolderOrganizer.onError=OnError;  

    PhotoFolderOrganizer.ValidateNameFunction=ValidateName;
    PhotoFolderOrganizer.ConfirmDeleteFunction=ConfirmDelete;
    PhotoFolderOrganizer.SortNodesFunction=SortNodes;
	PhotoFolderOrganizer.StorageDevice=StorageDevice;
	PhotoFolderOrganizer.FolderNameConvention=nameConvention;
	PhotoFolderOrganizer.ShowSelection=false;
	


	switch(g_StorageType)
	{
		case LOCAL: 
		 PhotoFolderOrganizer.InitPath=StorageDevice.VolumeName+"\\"+PhotoStorePath;
		 break;
		case ONLINE:
		 PhotoFolderOrganizer.InitPath="";
		 break;
		default:
		 PhotoFolderOrganizer.InitPath="";
		 break;
	}  

	//we have to set initial properties before calling open()
    if(parameters["state"] && parameters["state"]=="save")
	{
	  PhotoFolderOrganizer.ShowSelection=true;
	  PhotoFolderOrganizer.MultiSelection=false;
	  PhotoFolderOrganizer.SearchDepth=0 ;
	  PhotoFolderOrganizer.EnableDelete=false;
	  PhotoFolderOrganizer.EnableRename=false;
	  PhotoFolderOrganizer.EnableSetPermissions=false;
	  PhotoFolderOrganizer.EnableTellAFriend=false;
	  PhotoFolderOrganizer.EnableAddFolder=false;
	  PhotoFolderOrganizer.FolderIconURL=gFolderIconURL;
	}
	else if(parameters["state"] && parameters["state"]=="organize")
	{
	  PhotoFolderOrganizer.MimeTypes="";
	  PhotoFolderOrganizer.ShowSelection=false;
	  PhotoFolderOrganizer.MultiSelection=false;
	  PhotoFolderOrganizer.SearchDepth=1 ;
	  PhotoFolderOrganizer.FolderIconURL=gFolderIconURL;
	  
	  if(StorageDevice && StorageDevice.ReadOnly)
	  {
	    PhotoFolderOrganizer.EnableDelete=false;
	    PhotoFolderOrganizer.EnableRename=false;
	    PhotoFolderOrganizer.EnableAddFolder=false;
	  }
	  else
	  {
	    PhotoFolderOrganizer.EnableDelete=true;
	    PhotoFolderOrganizer.EnableRename=true;
	    PhotoFolderOrganizer.EnableAddFolder=true;
	  }
	        
      if(parameters["action"] && parameters["action"]=="add")
	  {
	  	 PhotoFolderOrganizer.Action="add";  
		 if(g_StorageType == ONLINE)
		    Heading.label="Create a shared album";
		 else
		    Heading.label="Add an Album";		    
		 PhotoFolderOrganizer.FolderIconURL="";
	  }
      else if(parameters["action"] && parameters["action"]=="delete")
	  {  
	  	 PhotoFolderOrganizer.Action="delete";
		 PhotoFolderOrganizer.EnableAddFolder=false;
		 PhotoFolderOrganizer.EnableRename=false;
		 PhotoFolderOrganizer.EnableSetPermissions=false;
		 PhotoFolderOrganizer.EnableTellAFriend=false;
	     PhotoFolderOrganizer.MultiSelection=true;
		 PhotoFolderOrganizer.ShowSelection=true;
		 PhotoFolderOrganizer.SearchDepth=0 ;
		 Heading.label="Delete Album";
		 PhotoFolderOrganizer.FolderIconURL=gFolderIconURL;
	  }
      else if(parameters["action"] && parameters["action"]=="notify")
	  {  
	  	 PhotoFolderOrganizer.Action="notify";
		 PhotoFolderOrganizer.EnableAddFolder=false;
		 PhotoFolderOrganizer.EnableRename=false;
		 PhotoFolderOrganizer.EnableTellAFriend=true;
		 PhotoFolderOrganizer.EnableDelete=false;
		 PhotoFolderOrganizer.EnableSetPermissions=false;
	     PhotoFolderOrganizer.MultiSelection=true;
		 PhotoFolderOrganizer.ShowSelection=true;
		 PhotoFolderOrganizer.SearchDepth=0 ;
		 Heading.label="Tell a Friend";
		 PhotoFolderOrganizer.FolderIconURL=gFolderIconURL;
	  }
      else if(parameters["action"] && parameters["action"]=="rename")
	  {
	     PhotoFolderOrganizer.MultiSelection=true;
		 PhotoFolderOrganizer.EnableAddFolder=false;
		 PhotoFolderOrganizer.EnableDelete=false;
		 PhotoFolderOrganizer.EnableTellAFriend=false;
		 PhotoFolderOrganizer.EnableSetPermissions=false;
		 PhotoFolderOrganizer.SearchDepth=0 ;
		 if(g_StorageType!=ONLINE)
		    Heading.label="Rename Album"; 
		 else
		    Heading.label="Rename shared albums"; 		    
		 PhotoFolderOrganizer.FolderIconURL=gFolderIconURL;
	     PhotoFolderOrganizer.Action="rename"; 
	  }
      else if(parameters["action"] && parameters["action"]=="setpermissions")
	  {
	     PhotoFolderOrganizer.MultiSelection=false;
		 PhotoFolderOrganizer.EnableAddFolder=false;
		 PhotoFolderOrganizer.EnableDelete=false;
		 PhotoFolderOrganizer.EnableTellAFriend=false;
		 PhotoFolderOrganizer.EnableRename=false;
		 PhotoFolderOrganizer.ShowSelection=true;
		 PhotoFolderOrganizer.SearchDepth=0 ;
		 Heading.label="Set Permissions for an Album"; 
   
		 PhotoFolderOrganizer.FolderIconURL=gFolderIconURL;
	  }
	  else
	  {
	     switch(g_StorageType)
		 {
			case LOCAL: 
		     Heading.label="Albums";
			 break;
			case ONLINE:
			 Heading.label=StorageDevice.name;
		     break;
			default:
		     Heading.label="";
			 break;
		 }  
	  }
	}
	else if(parameters["state"] && parameters["state"]=="screensaver")
	{ 
	  Heading.label="Change screensaver";
	  PhotoFolderOrganizer.Context="photo";
      PhotoFolderOrganizer.MultiSelection=true;
	  PhotoFolderOrganizer.ShowSelection=true;
	  PhotoFolderOrganizer.EnableDelete=false;
	  PhotoFolderOrganizer.EnableAddFolder=false;
	  PhotoFolderOrganizer.EnableTellAFriend=false;
	  PhotoFolderOrganizer.EnableRename=false;
	  PhotoFolderOrganizer.SearchDepth=0 ;
	  PhotoFolderOrganizer.FolderIconURL=gFolderIconURL;
	  PhotoFolderOrganizer.AllowSelectEmptyFolder=false;
	}

	PhotoFolderOrganizer.Open();

	var btn=GetButton("AddFolderBtn");
	btn.label="Add Album";
	btn=GetButton("RenameBtn");
	btn.label="Rename Albums";
	btn=GetButton("SetPermissionsBtn");
	btn.label="Set Permissions";
	btn=GetButton("DeleteBtn");
	btn.label="Delete Albums";
	btn=GetButton("TellAFriendBtn");
	btn.label="Tell a Friend";

	//set the style of list area and button area to photo style
	var listTable=GetListTable();
	listTable.className="infoArea";
	listTable.style.behavior="url(#default#gradient);";
 
    //Set the tip cell attributes
    var tipCell=GetTipCell();

	ActionCanceled=false;

    if(!StorageDevice)
	{
	   var info;
	   switch(g_StorageType)
	   {
		 case LOCAL:
			info="Local photo storage is not available. Please try again later.";
			break;
		 case ONLINE:
			info="Windows Live&trade; Spaces is currently not available. Please try again later.";			
			break;
		 default :
			break;
	   }	   
	   
       GetDescriptionCell().innerText=info;
	   return;
	}


    if(parameters["state"] && parameters["state"]=="organize")
	{

		if(parameters["action"]&&parameters["action"]=="add")
		{
		    UpdateAddContent();
            var objarray=PhotoFolderOrganizer.GetObjectArray("NewFolderTextbox")
			var textRange = objarray[0].createTextRange();
			textRange.collapse(false);
			textRange.select();
			delete objarray;
		}
		else if(parameters["action"]&&parameters["action"]=="rename")
		{
			UpdateRenameContent();
		}
		else if(parameters["action"]&&parameters["action"]=="setpermissions")
		{
			GetDescriptionCell().innerHTML="Choose the album you want to set permission and then select <em>Continue</em>";
			GetButton("CancelBtn").label="Cancel";
    		GetButton("SetPermissionsBtn").label="Continue";
            GetButton("CancelBtn").focus();
		}
		else if(parameters["action"]&&parameters["action"]=="notify")
		{
			GetDescriptionCell().innerHTML="Choose the albums (up to 10 at a time) you want to send your friends and then select <em>Continue</em>";
			GetButton("CancelBtn").label="Cancel";
    		GetButton("TellAFriendBtn").label="Continue";
            GetButton("CancelBtn").focus();
		}
		else if(parameters["action"]&&parameters["action"]=="delete")
		{
			if(g_StorageType!=ONLINE)
				GetDescriptionCell().innerHTML="Choose the album(s) you want to delete and then select <em>Delete</em>";
			else
				GetDescriptionCell().innerHTML="Select the album(s) you want to remove from your space, and then choose <em>Delete</em>";
			GetButton("CancelBtn").label="Cancel";
    		GetButton("DeleteBtn").label="Delete";
            GetButton("CancelBtn").focus();
		}		
   

	}


}

function OnBeforePreviewClose(panelname)
{
 if(panelname=="ScreenSaver")
 {
	Utilities.EnsureFolderExist(userDataVolumeName+"\\"+PhotoSettingsPath);
	if(oldScreensaver)
		Utilities.CreateTextFile(userDataVolumeName+"\\"+PhotoSettingsPath+"\\"+scFileName, oldScreensaver);
	else
		Utilities.RemoveFile(userDataVolumeName+"\\"+PhotoSettingsPath+"\\"+scFileName);
 }
}

function UpdateStorageInfo()
{
	 var objarray=PhotoFolderOrganizer.GetObjectArray("ButtonContainerTable")
	 var bcTable=objarray[0];
	 delete objarray;
	 objarray=null;
	 var cellObj;
     if(!bcTable.all.StorageInfoRow)
	 {

		var rowObj=bcTable.insertRow(-1);
		rowObj.id="StorageInfoRow"
		cellObj=rowObj.insertCell(-1);
        cellObj.id="StorageInfoCell";
		cellObj.style.fontFamily="segoe";
		cellObj.style.fontSize="16px";
	 }
	 else
	    cellObj=bcTable.all.StorageInfoCell;
	 if(parameters["state"]!="screensaver")
	 {
	   switch(g_StorageType)
	   {
		 case LOCAL:
				BOSPhotoCount = PhotoFolderOrganizer.TotalFileCount;
				cellObj.innerHTML="<table cellspacing=0 cellpadding=0 style='margin-left:5px'><tr ><td>Photo Storage:</td></tr><tr><td>"+BOSPhotoCount+" saved</td></tr><tr><td> "+(MAX_PHOTOS_ON_LOCAL_STORAGE-BOSPhotoCount)+" available"+"</td></tr></table>";
				break;
		 case ONLINE:
/*
			   var StoragePercentage=GetUsedPercentage(StorageDevice);
			   var htmlStr="<table cellspacing=0 cellpadding=0 style='margin-left:5px;margin-right:5px;'><tr ><td align=left>Storage used:</td></tr><tr><td> "+StoragePercentage+"%</td></tr>";
               
			   if(StoragePercentage<100 && StoragePercentage>0)
				   htmlStr +="<tr><td height=30 ><table width=100% cellspacing=0 cellpadding=0 BORDER=1 BORDERCOLOR=black><tr><td height=10 width="+StoragePercentage+"%  bgcolor=green></td><td></td></tr></table></td></tr></table>";
			   else if(StoragePercentage==100)
				   htmlStr +="<tr><td height=30 ><table width=100% cellspacing=0 cellpadding=0 BORDER=1 BORDERCOLOR=black><tr><td height=10 width=100%  bgcolor=#669999></td></tr></table></td></tr></table>";
			   else if(StoragePercentage==0)
				   htmlStr +="<tr><td height=30 ><table width=100% cellspacing=0 cellpadding=0 BORDER=1 BORDERCOLOR=black><tr><td height=10 width=100% ></td></tr></table></td></tr></table>";
			   if(StoragePercentage<0||StoragePercentage>100)
				   htmlStr ="<table cellspacing=0 cellpadding=0 style='margin-left:5px'><tr><td height=30 >Storage quota unavailable</td></tr></table>";
			        
			   cellObj.innerHTML=htmlStr;
	*/
			   break;
		 default:
		   break
	   }
	 }
	 else
	   cellObj.innerHTML="";
}

function GetUsedPercentage(sd)
{
    switch(g_StorageType)
	{
	  case LOCAL:
	   return Math.round(BOSPhotoCount/MAX_PHOTOS_ON_LOCAL_STORAGE*100);
	  case ONLINE:
	   var tsc=sd.TotalSectorCount;
	   var fsc=sd.FreeSectorCount
	   if(tsc>0 && fsc>=0)
	     return Math.round((tsc-fsc)*100/tsc);
	  default:
	   return -1;
	}
}

function OnInputPropertyChange()
{
  var eventSrc=window.event.srcElement;
  var propertyName=window.event.propertyName;

  if(propertyName=="value")
  {
     if(eventSrc.value)
        NewFolderSelectionID.checked=true;
  }
}

function OnNoItemSelected()
{
  if(parameters["action"] && parameters["action"]!="rename")
    alert("To complete selected activity, please choose an album.");
  else
    alert("No album name changed.");    
}

function TrimSpace(str)
{
   while(str.charAt(0)==' ')
      str=str.substr(1);
   while(str.charAt(str.length-1)==' ')
      str=str.substr(0,str.length-1);

	return str;
}

function OnSubmitNewname()
{
   PhotoFolderOrganizer.GetObjectArray("UserDefinedBtn2")[0].click();
}

function GotoEmail(destName)
{
	if(!OnlineStorageDevice){
		alert("MSNTV experienced a technical problem. Please try again later.");
		return;
	}
	var folderName = destName;

	var g_CID_HEX = TVShell.LoginManager.IDCRLGetCID( TVShell.LoginManager.User);
	var skyBrowseEntry = TVShell.ActiveServiceList("Skydrive::Browse");
	if(!skyBrowseEntry || skyBrowseEntry.URL==""){
		TVShell.Message("Failed in getting Serice List entry Skydrive::Browse");
		alert("MSNTV experienced a technical problem. Please try again later.");
		return;
	}
	var skyBrowseURL = skyBrowseEntry.URL;
	var spacesURL="";
	var subject="";
	var body= "";
	
	if ( folderName ==""){
	
		var albumsStr="";
		var checkedItems=PhotoFolderOrganizer.GetCheckedItems();
		for(i=0;i<checkedItems.length;i++)
		{
			folderName= checkedItems[i][1];
			spacesURL += i+1 +".'"+ folderName+"'";
			spacesURL += "\r\n";
			spacesURL += "http://cid-" + g_CID_HEX + "."+ skyBrowseURL + "/"+ escape(folderName);
			spacesURL += "\r\n\r\n";
		}
		if (i>1){ // there's more than albums selected
			subject = "Check out these photo albums";
			body=curUserFriendlyName + "<" + CurrentUser.Email + ">" + " has sent you the following web links to albums:  \r\n\r\n" + spacesURL;
		}
		else{ //there's only one album
			spacesURL= "http://cid-" + g_CID_HEX + "."+ skyBrowseURL + "/"+ escape(folderName);
			subject = "Check out this photo album '"+folderName +"'";
			body=curUserFriendlyName + "<" + CurrentUser.Email + ">" + " has sent you the following web link to the album '" +folderName +"'.\r\n\r\n" + spacesURL;
		}
	}
	else{
		spacesURL= "http://cid-" + g_CID_HEX + "."+ skyBrowseURL + "/"+ escape(folderName);
		subject = "Check out this just updated photo album '"+folderName +"'";
		body=curUserFriendlyName + "<" + CurrentUser.Email + ">" + " has just added photos to album '" +folderName +"'. Use the link below to view: \r\n\r\n" + spacesURL;
	}
	 
	var queryString = "?subject="+escape(subject)+"&body="+escape(body);
	if ( queryString.length > 2000)
		return alert("Since some albums have very long names we cannot proceed with all the selected albums.\r\n\r\nPlease select fewer number of albums and try again.");
	var writemailService = CurrentUser.ServiceList("mail::writemail");		
	if(writemailService)
	{
		var writemailURL = writemailService.URL;
		if(writemailURL)
		{
			writemailURL+=queryString;
			
	        var anchor = document.createElement("A");
	        document.body.appendChild(anchor);
			anchor.tabIndex = 0;
			anchor.href = writemailURL;
			anchor.click();			   
		}
	}		
}
	
function OnClickBtn(event)
{  
   if(parameters["state"]=="organize")
   {
       if(event.result=="AddFolderBtn")
       {
          if(parameters["action"]!="add")
		  {
			var newURL=document.location.href+"&action=add";
			document.location=newURL;
		  }
	   }
       if(event.result=="RenameBtn")
       {

			var newURL=document.location.href+"&action=rename";
			document.location=newURL;

	   }
	   else if(event.result=="SetPermissionsBtn")
       {
		 if(!parameters["action"])
		 {

			  var newURL=document.location.href+"&action=setpermissions";
			  document.location=newURL;
		 }
		 else if(parameters["action"]=="setpermissions")
		 {
		 	var checkedItems=PhotoFolderOrganizer.GetCheckedItems();
			if(!checkedItems || !checkedItems[0])
				return alert("You need to choose an album to finish selected action!");
			var albumsStr=""
			for(i=0;i<checkedItems.length;i++)
			{
			    if(i>0)
					albumsStr+="|";
				albumsStr+=escape(checkedItems[i][0]);
				albumsStr+=",";
				albumsStr+=escape(checkedItems[i][1]);
				albumsStr+=",";
				albumsStr+=escape(checkedItems[i][2]);
			}
			// Set permissions for the sky drive albums
			var newURL="msntv:/Photo/AlbumPermissions.html?"+albumsStr;
			document.location=newURL;
		 }
	   }
	   else if(event.result=="DeleteBtn")
       {
		 if(!parameters["action"])
		 {

			  var newURL=document.location.href+"&action=delete";
			  document.location=newURL;
		 }
	   }
	   else if(event.result=="UserDefinedBtn1")
       {
		 if(!parameters["action"])
		 {  
		 //   if(g_StorageType==ONLINE)
		//	{  
		//	    // Tell a Friend
		//	    GotoEmail("");
         //  }
		//	else if(g_StorageType==LOCAL)
			if(g_StorageType==LOCAL)
			{
			  var newURL=document.location.href+"&state=screensaver";
			  document.location=newURL;
			}
		 }
	   }
	   else if(event.result=="TellAFriendBtn")
	{
		 if(!parameters["action"])
		 {  
			  var newURL=document.location.href+"&action=notify";
			  document.location=newURL;
		}
		 else if(parameters["action"]=="notify"){
				// Tell a Friend
				
				var checkedItems=PhotoFolderOrganizer.GetCheckedItems();
				if(!checkedItems || !checkedItems[0])
					return alert("You need to choose an album to finish selected action!");
				if( checkedItems.length > 10)
					return alert("You have selected "+ checkedItems.length +" albums.\n\n A maximum of only 10 albums can be selected at a time for 'Tell a Friend'.");
				
				GotoEmail("");
		}
	}
	   else if(event.result=="CancelBtn")
       {
		 history.back();
	   }   
   }
   else if(parameters["state"]=="save")
   {
	   if(event.result=="UserDefinedBtn2")
	   {  
	  
		  var checkedItems=new Array();
		  var isNew = false;
		  if(PhotoFolderOrganizer.GetObjectArray("NewFolderSelectionID")[0].checked)
		  {

		     var newName=TrimSpace(PhotoFolderOrganizer.GetObjectArray("FolderNameInput")[0].value);

             if(ValidateName(newName))
             {
			     checkedItems[0]=new Array();
				 switch(g_StorageType)
				 {
					case LOCAL: 
					 checkedItems[0][0]=PhotoFolderOrganizer.InitPath+"\\" +newName;
					 checkedItems[0][1]=newName;
					 break;
					case ONLINE:
					 checkedItems[0][0]=PhotoFolderOrganizer.InitPath;
					 checkedItems[0][1]=newName;
					 break;
					default:
					 checkedItems[0][0]="";
					 checkedItems[0][1]="";
					 break;
				 }  
				 var oldNames=PhotoFolderOrganizer.GetDisplayNames()
				 if(oldNames)
				 {
				 	for(i=0;i<oldNames.length;i++)
				    {
					   if(oldNames[i].toLowerCase()==newName.toLowerCase())
					   {  alert("There is already an album with that name. Please enter a new name.");
						  return;
					   }
					}
				 }

				 checkedItems[0][1]=newName;
				 isNew = true;
			 }
			 else
			 {
			     alert("Please enter a valid album name. " + nameConvention);
				 return;
			 }
		  }
		  else
		     checkedItems=PhotoFolderOrganizer.GetCheckedItems();
		  
		  
		  if(!checkedItems || checkedItems.length<=0)
			 alert("Please select an album or add a new album to save photos.");
		  else
		  { 
		         destPath=checkedItems[0][0];
		         destName=checkedItems[0][1];
		         if(g_StorageType == ONLINE)
					destPermission=checkedItems[0][2];
				else
					destPermission="";

		  	     switch(g_StorageType)
				 {
				    case LOCAL:
					   SavePhotos();
					   break;
					case ONLINE:
					   if(isNew && (StorageDevice.CreateDirectory(destPath,destName)==0))
					   {
						  currentEnumeration = StorageDevice.EnumerateItemsXML(PhotoFolderOrganizer.InitPath, SupportedPhotoMIMETypes,"async=1");
 					   }
					   else if(isNew)
					   {
					       alert("Failed to create new album! Please try again later");
						   history.back();
						   return;
					   }
					   else
					   	   SavePhotos();
					   break;
					default:
					   break;
				 }
		  }
	   }
       else if(event.result=="CancelBtn")
       {
		 history.go(-1);
	   }
    

	}
	else if(parameters["state"]=="screensaver")
	{
	   if(event.result=="UserDefinedBtn2")
	   {  
			  var info="Choose <em>Continue</em> to see a preview of your photo screensaver. <p><p>Press any key on your keyboard or remote to end the preview and return here.";
			  var result=PanelManager.CustomMessageBox(info,"","Continue;Cancel",0,"", true,MGX_ICON_INFO);
			  if(result==0)
				  PreviewScreensaver()			  
			  else
			    return;
	   }
	   else if(event.result=="UserDefinedBtn1")
	   {
		   SaveScreensaver(false);
           PanelManager.AnimationMessageBox("You've successfully saved your screensaver setting.", "msntv:/Panels/Images/TaskCompleted.gif", "Task_Complete", 2000);
		   setTimeout("history.back()",2000);
	   }

	   else if(event.result=="CancelBtn")
	   {
		 var currStr=GetScreensaverStr();
		 var savedStr=Utilities.ReadTextFile(userDataVolumeName+"\\"+PhotoSettingsPath+"\\"+scFileName);
		 if(currStr!=savedStr)
		 {
		   var info="Your changes have not been saved!"
		   var result=PanelManager.CustomMessageBox(info,"","Save;Do not save;",0,"", true);
		   if(result==0)
		   {
		   	  SaveScreensaver(false);
              PanelManager.AnimationMessageBox("You've successfully saved your screensaver setting.", "msntv:/Panels/Images/TaskCompleted.gif", "Task_Complete", 2000);
		      setTimeout("history.back()",2000);
		   }
		   else
			  history.back();
		 }

		 else 
		   history.back();
	   }
	}
}


function OnClickItem(event)
{
	var path=event.result[0];
	var displayname=event.result[1];

	var destURL="msntv:/photo/Viewer.html?location=";
	destURL+=(g_StorageType==LOCAL)?"1":"3";
	destURL+="&StorageDeviceVN=";
	destURL+=encodeURIComponent(StorageDevice.VolumeName);
	destURL+="&path=";
	destURL+=encodeURIComponent(path);
	destURL+="&parentFolderName="+encodeURIComponent(displayname);	 
	
	TVShell.Message("destURL = " + destURL);
	
	document.location=destURL;
}

function OnFolderFocusIn(event)
{   
    if(g_fLoading)
	  return;
    RemoveThumbnail(event.result)
	AddSlideShow(event.result);
	delete event;

}

function OnFolderFocusOut(event)
{
    if(g_fLoading)
	  return;
    RemoveSlideShow(event.result);
	AddThumbnail(event.result);
	delete event;
}


function OnAddComplete(event)
{   
	TVShell.EventLog.Usage("photo","action=AlbumCreated");
	PanelManager.AnimationMessageBox("You've successfully created an album", "msntv:/Favorites/img/FavSave.gif", "Task_Complete", 1000);
    history.back();
}

function OnError(event)
{  
   var action=event.action;
   var code=event.code;


   switch(code)
   {
     case 2:
         if(action=="rename")
		   alert("Couldn't find the selected album.");
	     break;
	 case 3:
	 case 80:
	 case 183:
			alert("There is already an album with that name. Please enter a new name.");	
         break; 
	 default:
	     alert("MSNTV experienced a technical problem. Please try again.");
	     break;

   }

   	delete event;

}

function OnRenameComplete(event)
{
 	TVShell.EventLog.Usage("photo","action=AlbumNameChanged");
	PanelManager.AnimationMessageBox("Album name(s) changed.", "msntv:/Favorites/img/FavSave.gif", "Task_Complete", 1000);
    history.back();
}

function OnRenameOneComplete(event)
{
//TVShell.EventLog.Usage("photo","action=PhotoNameChanged");
    var newName=event.newName;
	var oldName=event.oldName;
	 var scAlbumStr=Utilities.ReadTextFile(userDataVolumeName+"\\"+PhotoSettingsPath+"\\"+scFileName);
	 var newSCAlbumStr="";

	 if(scAlbumStr)
	 {
		 var albums=scAlbumStr.split("\n");
		 var i=0;
		 var count=0;
		 for(i=0;i<albums.length;i++)
		 {
			count++;
			if(count>1)
				newSCAlbumStr+="\n";
			if(albums[i]!=oldName)
			{
			  newSCAlbumStr+=albums[i];
			}
			else
			  newSCAlbumStr+=newName;
		 }

         Utilities.RemoveFile(userDataVolumeName+"\\"+PhotoSettingsPath+"\\"+scFileName);
		 Utilities.CreateTextFile(userDataVolumeName+"\\"+PhotoSettingsPath+"\\"+scFileName,newSCAlbumStr);

	 }

	 delete event;

}

function OnDeleteComplete(event)
{
 	 PanelManager.AnimationMessageBox("Selected album(s) deleted.", "msntv:/Favorites/img/FavSave.gif", "Task_Complete", 1000);
     history.back();
}

function OnDeleteOneComplete(event)
{
   var deletedAlbum=(event.deletedItem)[1];
   if(deletedAlbum)
   {
     
	 var scAlbumStr=Utilities.ReadTextFile(userDataVolumeName+"\\"+PhotoSettingsPath+"\\"+scFileName);
	 var newSCAlbumStr="";

	 if(scAlbumStr)
	 {
		 var albums=scAlbumStr.split("\n");

		 var i=0;
         var count=0;
		 for(i=0;i<albums.length;i++)
		 {
			
			if(albums[i]!=deletedAlbum)
			{
			  count++;
			  if(count>1)
			    newSCAlbumStr+="\n";
              newSCAlbumStr+=albums[i];
			}
		 }

	     Utilities.RemoveFile(userDataVolumeName+"\\"+PhotoSettingsPath+"\\"+scFileName);
		 Utilities.CreateTextFile(userDataVolumeName+"\\"+PhotoSettingsPath+"\\"+scFileName,newSCAlbumStr);
	 }

  }
  	delete event;
}


function saveAlbumDiploma()
{
	var diplomaMsg = "<p>Photos you place in albums are saved at a lower quality that is suitable for viewing on TV.<br>Keep your original photos in another location.</p>";

	DiplomaCustomMessageBox(0,MDIPLOMA_SAVEALBUM,diplomaMsg,"","Continue",0,"", true, MGX_ICON_WARNING,MGX_SIZE_LARGE);
}


function OnAlbumsBuildCompleted()
{
	var rows=PhotoFolderOrganizer.GetObjectArray("FolderRow");
	var isEmpty=false;


	if(!rows|| !rows[0])
		isEmpty=true;
    
	delete rows;
	var descriptionCell=GetDescriptionCell();

	if(parameters["state"] && parameters["state"]=="organize")
	{
		if(!parameters["action"])
		{
			if(isEmpty && StorageDevice)
			{			  
				switch(g_StorageType)
				{
				case LOCAL: 
					descriptionCell.innerHTML="Photos are saved to your "+ProductShortName+" inside of albums. Choose <em>Add Album</em> to create a new album.";
					break;
				case ONLINE:
					descriptionCell.innerHTML="Photos are saved to Windows Live&trade; SkyDrive inside photo albums. Choose <em>Add Album</em> to create a new album.";
					break;
				default:
					break;
				}
				//Show the Add Album button
				var btn=GetButton("AddFolderBtn");
				btn.style.display="block";  		  
			}
			else if(StorageDevice)
			{
				switch(g_StorageType)
				{
				case LOCAL: 
					descriptionCell.innerHTML="Photos are saved to your "+ProductShortName+" inside albums.  Choose the album name to view it.";
					break;
				case ONLINE:
					descriptionCell.innerHTML="Choose an album to view the photos in it, or choose a button to modify your space.";
					break;
				default:
					break;
				}  		  
            }
			else
			   GetDescriptionTable().style.display="none";
						
		//	if(g_StorageType==ONLINE)
		//	{
		//		var btn=GetButton("TellAFriendBtn");
		//		btn.label="Tell a Friend";
		//		if(StorageDevice && !StorageDevice.ReadOnly)
		//			btn.style.display="block";
		//			
		//			
		//	}
			if(g_StorageType==LOCAL){
				GetButton("TellAFriendBtn").style.display="none";
				GetButton("SetPermissionsBtn").style.display="none";
			}
			
			if(!isEmpty)
			{
				
				var objarray=PhotoFolderOrganizer.GetObjectArray("itemLink");
				if(!UNDER_NT)
					objarray[0].focus();
				delete objarray;
			}

        }
	}
    else if(parameters["state"] && parameters["state"]=="save")
	{
		var btn=GetButton("UserDefinedBtn2");
		btn.label="Continue";
		btn.style.display="block";	

		if ( IsSignedIn() )
			setTimeout("saveAlbumDiploma()", 1);
		
		var saveStr;
		if ( g_StorageType == ONLINE ){
			Heading.label="Place photos in a shared album";
			saveStr = "share";
		}
		else{
			Heading.label="Save Photos to Album";
			saveStr = "save";
		}
		btn.focus();
		
		var rows=PhotoFolderOrganizer.GetObjectArray("FolderRow");

		var isEmpty=false;
		if(!rows|| !rows[0])
		   isEmpty=true;
		
		if(isEmpty)
		{
			switch(g_StorageType)
			{
			case LOCAL: 
				descriptionCell.innerHTML="Photos are saved to your "+ProductShortName+" inside of albums. To save these photos to your "+ProductNickname+", you must first create an album. Type a name for your album below, then choose <em>Continue</em>. ";
				break;
			case ONLINE:
				descriptionCell.innerHTML="Photos are saved to Windows Live&trade; Spaces inside of albums. To save these photos to your space, you must create a shared album. Type a name for your album, and then <br>choose <b>Continue</b>. ";
				break;
			default:
				break;
			}  		  
		}
		else
		{
		  if(g_StorageType==ONLINE)
		    descriptionCell.innerHTML="Choose the album where you want to share the photos you've selected, and then choose <em>Continue</em>. To create a new album, type a name for it in the box at the bottom of the page and then choose <em>Continue</em>.";
		  else
		    descriptionCell.innerHTML="Choose the album where you want to " + saveStr + " these photos, and then choose <em>Continue</em>. To create a new album, type a name for it in the box at the bottom of the page and then choose <em>Continue</em>.";
		}
		var newAlbumHTML="";

		if(isEmpty)
		{  
		    newAlbumHTML="<table width=100%  cellpadding=0 cellspacing=0>"+
							"<tr height=8><td colspan=6></td></tr>"+
							"<tr height=30>"+
							  "<td width=15></td>"+
							  "<td><input  name=SelectionInputName id='NewFolderSelectionID' style='display:none' type=radio checked onfocus=\"DoScroll('scrollToEnd')\" ></td>"+
							  "<td width=105 NOWRAP style='font-family:segoe;font-size:18px;;color:#000000'>New album:</td>"+
							  "<td width=250 align=left><form id=newNameForm name=theForm action='javascript:OnSubmitNewname();' style='padding:0px; margin:0px;'>"+
							  "<input class=inputText id=FolderNameInput type=text style='width:100%' maxlength=30 onfocus=\"DoScroll('scrollToEnd')\" onpropertychange='OnInputPropertyChange()' ></form></td>"+
		                      "<td width=20></td></tr>"+
							  "</table>"
		}
		else
		{
		    newAlbumHTML="<table width=100%  cellpadding=0 cellspacing=0>"+
							"<tr height=8><td colspan=6></td></tr>"+
							"<tr height=30>"+
							  "<td width=13></td>"+
							  "<td><input  name=SelectionInputName id='NewFolderSelectionID' type=radio onfocus=\"DoScroll('scrollToEnd')\"></td>"+
						      "<td width=10></td>"+						  
							  "<td width=105 NOWRAP style='font-family:segoe;font-size:18px;color:#000000'>New album:</td>"+
							  "<td width=250 align=left><form id=newNameForm name=theForm action='javascript:OnSubmitNewname();' style='padding:0px; margin:0px;'>"+
							  "<input class=inputText id=FolderNameInput type=text style='width:100%' maxlength=30 onfocus=\"DoScroll('scrollToEnd')\" onpropertychange='OnInputPropertyChange()'></form></td>"+
		                      "<td width=20></td></tr>"+
						  "</table>"


		}
		var objarray=PhotoFolderOrganizer.GetObjectArray("_OrganizerScrollingTable");
		objarray[0].insertAdjacentHTML("afterEnd", newAlbumHTML);
		delete objarray;
		btn=GetButton("CancelBtn").label="Cancel";

		var tipCell=GetTipCell();
		
		switch(g_StorageType)
		{
			case LOCAL: 
			case ONLINE:
				oldTipHTML=tipCell.innerHTML;
				tipCell.innerHTML="Tip: Photos you place in albums are saved at a lower quality that is suitable for viewing on TV."
				break;
			default:
				break;
		}  			
		
		if(isEmpty)
		{
		   document.all.FolderNameInput.focus();
		}

	}
		else if(parameters["state"] && parameters["state"]=="screensaver")
	{
		  GetButton("SetPermissionsBtn").style.display="none";
		  var btn=GetButton("UserDefinedBtn1");
		  btn.style.display="block";	
		  btn.label="Save";	
		  var btn=GetButton("UserDefinedBtn2");
		  btn.style.display="block";	
		  btn.label="Preview";	
		  btn.focus();
		  btn=GetButton("CancelBtn");
		  btn.label="Cancel";

		  list=PhotoFolderOrganizer.GetObjectArray("FolderRow");
          
		  if(!list ||!list[0])
		  {
			var htmlStr ="<table style='width:100%;' cellspacing=0 cellpadding=0 ><tr><td id=NoContentCell align=center width=100% height=100%>No album found. </td></tr></table>";
			var rowObj=PhotoFolderOrganizer.GetObjectArray("_OrganizerScrollingTable")[0].insertRow(-1);
			var cellObj=rowObj.insertCell(-1);
			cellObj.innerHTML=htmlStr;
			cellObj.style.width="100%";
			cellObj.innerHTML=htmlStr;
			GetButton("CancelBtn").focus();
			GetButton("UserDefinedBtn1").style.display="none";
			GetButton("UserDefinedBtn2").style.display="none";
			delete list;
		  }

		 
		  var albumStr=Utilities.ReadTextFile(userDataVolumeName+"\\"+PhotoSettingsPath+"\\"+scFileName);

			 if(albumStr)
			 {
				 var albums=albumStr.split("\n");
				 var i=0;

				 for(i=0;i<list.length;i++)
				 {					
					var tempName=list[i].all.FolderNameSpan.innerText;
					var j=0;
					for(j=0;j<albums.length;j++)
					{
					  if(albums[j]==tempName)
					  {
					   list[i].all.ItemSelectionInput.click();
					   break;
					  }
					}

				 }
			 }

			GetTipCell().innerHTML="Select album(s) you want to use for screensaver."

		//set the style of list area and button area to photo style
		GetDescriptionTable().style.display="none";
		oldScreensaver=Utilities.ReadTextFile(userDataVolumeName+"\\"+PhotoSettingsPath+"\\"+scFileName);
	    Sink.AttachEvent(PanelManager,"OnBeforeClose",OnBeforePreviewClose);

	}

	if(!isEmpty && g_StorageType==LOCAL && parameters["state"] &&parameters["state"]=="organize" &&!parameters["action"])
	{

		btn=GetButton("UserDefinedBtn1");
		btn.label="Screensaver";
		btn.style.display="block"
	}


	if(!isEmpty)
		AddVisuals();

	UpdateStorageInfo();

	g_fLoading=false;
    var rows=PhotoFolderOrganizer.GetObjectArray("FolderRow");
    if(!rows || !rows[0])
       return;

	RemoveThumbnail(0);
	AddSlideShow(0);

	DoScroll("scrollToStart");
}
function OnInvalidName(event)
{
    var folderName = event.result;
    folderName = folderName.replace(/&/,"&amp;");
    folderName = folderName.replace(/</,"&lt;");
    folderName = folderName.replace(/>/,"&gt;"); 
      
   var msg= "<em>'"+folderName+"'</em> is an invalid name.<p><p>"+nameConvention;
   delete event;
   PanelManager.CustomMessageBox(msg,"", "OK", 0,"",true);
}

function GetScreensaverStr()
{
	var checkedItems=PhotoFolderOrganizer.GetCheckedItems();
    
    var albumStr="";
    for(i=0;i<checkedItems.length;i++)
	{  
	  if(i>0)
	    albumStr+="\n";
      albumStr+=checkedItems[i][1];
	}   
	return albumStr;
}

function SaveScreensaver(IsPreview)
{
    var albumStr=GetScreensaverStr()

	Utilities.EnsureFolderExist(userDataVolumeName+"\\"+PhotoSettingsPath);
	if(albumStr)
		Utilities.CreateTextFile(userDataVolumeName+"\\"+PhotoSettingsPath+"\\"+scFileName, albumStr);
	else
		Utilities.RemoveFile(userDataVolumeName+"\\"+PhotoSettingsPath+"\\"+scFileName);
    if(!IsPreview)
    {
	  oldScreensaver=albumStr;
	  TVShell.EventLog.Usage("photo","action=screensaverChange");
    }
}

function PreviewScreensaver()
{
   
   SaveScreensaver(true);
   TVShell.ScreenSaver.Start();
}

function GetDescriptionCell()
{
   var objArray=PhotoFolderOrganizer.GetObjectArray("DescriptionCell");
   
   var result=objArray[0];
   delete objArray;
   return result;
}

function GetDescriptionTable()
{
   var objArray=PhotoFolderOrganizer.GetObjectArray("DescriptionTable");
   var result=objArray[0];
   delete objArray;
   return result;
}

function GetTipCell()
{
   var objArray=PhotoFolderOrganizer.GetObjectArray("TipCell");
   var result=objArray[0];
   delete objArray;
   return result;
}

function GetListTable()
{
   var objArray=PhotoFolderOrganizer.GetObjectArray("ListContainerTable");
   var result=objArray[0];
   delete objArray;
   return result;
}

function GetButton(buttonID)
{
   var objArray=PhotoFolderOrganizer.GetObjectArray(buttonID);
   var result=objArray[0];
   delete objArray;
   return result;
}


function UpdateAddContent()
{     
	GetButton("AddFolderBtn").label="Add";
	var descriptionCell=GetDescriptionCell();
	PhotoFolderOrganizer.GetObjectArray("AddFolderInputLabel")[0].innerText="Album name:"

	switch(g_StorageType)
	{
		case LOCAL: 
		 descriptionCell.innerHTML="You can save photos to your "+ProductShortName+" inside of albums. Type a name for the album you want to add, and then choose <em>Add</em>"
		 break;
		case ONLINE:
		 descriptionCell.innerHTML="To share photos online, you must place them in an album on your space. To create a shared album, type an album name and then choose <em>Add</em>."
		 GetTipCell().innerHTML="Tip: To add photos to a shared album, choose a photo location (for example, Albums, Devices, or Photos in Mail) from Photos Home, and then choose <em>Share Photos</em>."
		 break;
		default:
		 break;
	}  
}

function DoScroll(direction)
{
   PhotoFolderOrganizer.GetObjectArray("_OrganizerScrollingDiv")[0].MyDoScroll(direction);
}

function UpdateRenameContent()
{     
	GetButton("CancelBtn").label="Cancel";
	if(g_StorageType==ONLINE)
		GetDescriptionCell().innerHTML="Type a new name for any of the albums on your space, and then choose <em>Save Changes</em>.";
	else
		GetDescriptionCell().innerHTML="Type a new name for any of the albums below, and then choose <em>Save Changes</em>.";
			
	GetButton("RenameBtn").label="Save Changes";
	
//  this line to adjust scrolling div to scroll bar
//	DoScroll("up");

	var firstInput=PhotoFolderOrganizer.GetObjectArray("FolderRenameInput")[0]
	if(firstInput)
	{
	  firstInput.select();
	  if(!UNDER_NT)
		firstInput.focus();
	}
}

function ShowButton(btnID ,show)
{
   var btn=GetButton(btnID);
   if(show)
      btn.style.display="block";
   else
      btn.style.display="none";      
}

var currentEnumeration=null;


function OnEnumComplete(sd,result)
{
	// ignore if this is not our enumeration
	if ( !currentEnumeration ) return;
	if ( !result ) return;
	if ( currentEnumeration.Id != result.Id ) return;
	if(!destName) return;
	var xmlDoc = result.XMLDoc;	
	if(xmlDoc)
	{
		var nodes = xmlDoc.selectNodes("//a:response[a:propstat/a:prop/a:iscollection = 1]");
		if (nodes){
			for (i = 0; i < nodes.length; i++)
			{
				if(destName==nodes[i].selectSingleNode(".//a:displayname").text)
				{
					destPath=nodes[i].selectSingleNode(".//a:href").text
					break;
				}
			}
		}
	}

	delete xmlDoc;
	xmlDoc=null;
	if(destPath)						   
	{
	  SavePhotos();
	}
}

Sink.AttachEvent(TVShell.StorageManager,"OnEnumComplete" , OnEnumComplete);

var OnlineIdx;
var OnlineCount;

function GuessPictureName(url)
{
    var name;
    
    if (url.indexOf("http://")>=0) {
        var expr = /((\w|\s|\d|\.)+)\.jpg.*$/;
        expr.exec(url);
        name = RegExp.$1;
    }
    else {
        name = url.slice(url.lastIndexOf("\\") + 1);
    }
    if (name=="") {        
	    var dateObj=new Date();
        name = dateObj.getTime() + "_image.jpg";   
    }
    
    return name;
}

function SavePhotos()
{
   TVShell.Message("Savephotos");
    var tempFileName = tempDir + "\\photo\\TempSelectedPhotoListForSave.txt";
	var listStr=Utilities.ReadTextFile(tempFileName);
    var list;

	if(checkedList){
		delete checkedList;
		checkedList=null;
	}
	checkedList=new Array();
    
	if(listStr)
         list=listStr.split("\n");
    var count=list.length;
	var j=0;

	for(i=0;i<count;i++)
	{
       if(list[i]){
         checkedList[j]=list[i];
		 j++;
	  }
	}
	if(g_StorageType == LOCAL)
	{
		if((checkedList.length+parseInt(BOSPhotoCount))>MAX_PHOTOS_ON_LOCAL_STORAGE)
		{
		    if(parseInt(BOSPhotoCount)<MAX_PHOTOS_ON_LOCAL_STORAGE)
				var msg="You are attempting to add "+checkedList.length+" photos to an album.  Only "+(MAX_PHOTOS_ON_LOCAL_STORAGE-parseInt(BOSPhotoCount))+" more photos can be saved. Please select fewer photos or discard some photos first.";
			else
				var msg="You already have "+MAX_PHOTOS_ON_LOCAL_STORAGE+" photos saved and you can't add any more.";
				
			PanelManager.CustomMessageBox(msg,"", "Cancel", 0,"",true);
			history.go(-1);
			return;
		}
	}

	if(checkedList.length > 0) {
	   ShowProgressPanel();
       SetProgressText(((g_StorageType == LOCAL)? "Saving" : "Sharing" ) + " photos, please wait...");
       SetProgressPercent(0);
	   SetProgressStopFunction(CancelSave);
	   setTimeout("StartSave()",50)
	}
}


function CleanupAbortedSave(userCancelled)
{
	if (userCancelled==false)
	{
		var msg = "We're having trouble saving your photo.<p><p> There seems to be a problem retrieving the photo. You may need to wait before trying again.";
		var ret = PanelManager.CustomMessageBox(msg,"", "OK", 1,"");
	}

	if ( resizeTimerId > 0 )
		clearTimeout(resizeTimerId);

	tempImage.onload = null;
	tempImage.index=0;
	savedPhotoCount=0;
	destPath="";
	destName="";
	HideProgressPanel();
	history.back();
}

function StartSave()
{
	SavePhoto(0);
}

var resizeTimerId = -1;
function SavePhoto(index)
{
	try
	{
		tempImage.onload = OnImageLoad;
		tempImage.index = index;
		if ( checkedList[index] ) 
		{
			var oldLoc = location;
			var oldXMLFile = XMLFileURL;
			location = 2;
			XMLFileURL=null;
			var data = new Object();
			data.index = index;
			data.src = checkedList[index];
			resizeTimerId = setTimeout(function(){OnResized(null,null,false);},IMAGE_DOWNLOAD_TIMEOUT);
			var temp=ResizeAndGetURL(data.src, false, OnResized, data );
			location = oldLoc;
			XMLFileURL=oldXMLFile;

			if ( !IsDefaultResizeFile(temp) ) 
				OnResized(data, data.src,1);
		} else {
			setTimeout( SaveNextPhoto, 50 );
		}
	}
	catch (ex)
	{
		TVShell.Message( "SavePhoto(index="+index+"):" +ex+ " " + ex.description );
		CleanupAbortedSave(false);
		return;
	}
}

function OnResized(data,localPath,opStatus)
{
	if (resizeTimerId != -1)
		clearTimeout(resizeTimerId);
	resizeTimerId = -1;
	if ( opStatus )
		FinishSave(data);
	else
		CleanupAbortedSave(false);
}

function FinishSave(data)
{
	try
	{
		var src = checkedList[data.index]
		var oldLoc = location;
		var oldXMLFile = XMLFileURL;

		//Use sync version to get filename. It should already be
		//in the cache
		location = 2;
		XMLFileURL=null;
		var temp=ResizeAndGetURL(src, true);
		location = oldLoc;
		XMLFileURL=oldXMLFile;
   
		temp=ChangeBackwardToForwardSlash(temp);
		tempImage.src = temp;
		tempImage.imgSrc = temp;
		TVShell.Message("tempImage.src = " + tempImage.imgSrc);
	}
	catch (ex)
	{
		TVShell.Message( "FinishSave():" +ex+ " " + ex.description );
		CleanupAbortedSave(false);
		return;
	}
}

function OnImageLoad()
{
	var photoSrc = this.imgSrc;
	TVShell.Message("photoSrc = " + photoSrc);
	var srcFileName = photoSrc;
	
	if(this.index==checkedList.length - 1)
	  tempImage.onload = null;

	var pos = srcFileName.lastIndexOf("file://");
	if(pos!=-1)
	   srcFileName = srcFileName.slice(pos+7);
	
	srcFileName = ChangeForwardToBackwardSlash(srcFileName);	
		
	this.src = "";

	if ( ActionCanceled )
		return;
	
	if(destPath && srcFileName)
	{		
		if(g_StorageType == LOCAL)
		{
			if(!userDataPath)
			return;
		    
			var dateObj=new Date();
	    	
			var dstURL =  destPath+"\\"+dateObj.getTime()+""+this.index+".jpg";
		    
			if (IsNetworkFile(photoSrc))
			{
				srcFileName = photoSrc;
			}

			if(ThumbnailManager.CopyFileToURL(srcFileName, dstURL))
			{
				BOSPhotoCount++;

				savedPhotoCount++;
				var percent=parseInt((this.index+1)/(checkedList.length)*100);

				SetProgressPercent(percent);
				SetProgressText("Saving photo "+(this.index+1)+" of "+checkedList.length+" ...");
				setTimeout("SaveNextPhoto()",50); //give a chance to IE to update progress info
			}
		}
		else if(g_StorageType == ONLINE)
		{
			if ( ActionCanceled )
				return;
			
			if(StorageDevice.SaveFile(srcFileName, destPath)==0)
			{
				TVShell.Message(" saved file " + srcFileName + " to online storage");
				savedPhotoCount++;
			}
			else
			{
				TVShell.Message(" could not save file " + srcFileName + " to online storage");
			}
			
			if ( !ActionCanceled ){
				var percent=parseInt((this.index+1)/(checkedList.length)*100);

				SetProgressPercent(percent);
				SetProgressText("Sharing photo "+(this.index+1)+" of "+checkedList.length+" ...");
				setTimeout("SaveNextPhoto()",50); //give a chance to IE to update progress info			
			}
		}	
    }
}
			
// fetch the next photo
function SaveNextPhoto()
{
	try 
	{
		if(tempImage.index < checkedList.length)
		{
			tempImage.index++;
			SavePhoto( tempImage.index );
			return;
		}
	
 		// hide the panel once done
 		if(tempImage.index == checkedList.length)
		{	
		    tempImage.onload=null;
		    tempImage.src="";
			tempImage.index = -1;

			HideProgressPanel();
			
			var nPhotosToSave = checkedList.length;
			var failureCount  = nPhotosToSave - savedPhotoCount;
			TVShell.Message( "nPhotosToSave = " + nPhotosToSave + " failureCount = " + failureCount + " savedPhotoCount = " + savedPhotoCount   );
			
			if(savedPhotoCount > 0)
			{
			    TVShell.EventLog.Usage("photo","action=photoSaved");
			    UpdateStorageInfo();
				var buttonText = "View;Done";
				var buttonPadding = 1;  // "Tell a Friend" button for online storage
		    	var msg = "You have successfully added " + savedPhotoCount+(savedPhotoCount>1?" photos":" photo")+" to <em>"+destName+"</em> album.";
				var msgTitle = (savedPhotoCount > 1) ? "Photos " : "Photo ";
		        var saved= parseInt(BOSPhotoCount)+parseInt(savedPhotoCount);
				if(g_StorageType == LOCAL)
				{
		    		msg+="<p><br>Total Saved: ";
	    			msg+=saved;

		    		msg+=(saved>1)? " photos" : " photo";
	    			msg+=" <p>";
		    		msg+="Space available: ";
					msg+=100 - saved;
					msg+=((100 - saved)>1)? " photos" : " photo";
					msgTitle += "Saved";
				}
				else{
					TVShell.EventLog.Usage("PhotoSharing", "PublishPhotos" );
					TVShell.Message("Onlinestorage: photos saved: " + savedPhotoCount);
					if (!destPermission || destPermission == "Public" || destPermission == "Shared"){
						buttonText = "Tell a Friend;" + buttonText;
						buttonPadding = 0;  // don't need padding
					}
					msgTitle += "Shared";
				}
				
				var ret = PanelManager.CustomMessageBox(msg,msgTitle, buttonText, 0,"",true, MGX_ICON_INFO);
				switch ( (ret + buttonPadding ) ){
					case 0:
						PanelManager.Item("main").NoBackToMe=true;
						GotoEmail(destName);
						break;
					case 1:
						var destURL="msntv:/photo/Viewer.html?location=";
						destURL+=(g_StorageType == LOCAL) ? "1" : "3";
						destURL+="&StorageDeviceVN=";
						destURL+=encodeURIComponent(StorageDevice.VolumeName);
						destURL+="&path=";
						destURL+=encodeURIComponent(destPath);
						destURL+="&parentFolderName="+encodeURIComponent(destName);
						destURL += "&backCount=1";
						PanelManager.Item("main").NoBackToMe=true;				
						document.location=destURL;
						break;
					default:
						history.go(-1);
				}
		    }
		    else if(failureCount > 0)
		    {
				var errPhotoStr = ( failureCount == 1? "photo" : failureCount == nPhotosToSave ? "all photos" : "" + failureCount + " photos");
				var titlePhotoStr;
				if ( nPhotosToSave == 1 )
				{
					errPhotoStr = "selected photo.";
					titlePhotoStr = "Photo";
				}
				else if ( failureCount == 1 )
				{
					errPhotoStr = "1 of the " + nPhotosToSave + " photos that were selected.";
					titlePhotoStr = "Photo";
				}
				else if ( failureCount == nPhotosToSave )
				{
					errPhotoStr = "any of the " + nPhotosToSave + " photos that were selected.";
					titlePhotoStr = "Photos";
				}
				else
				{
					errPhotoStr = "" + failureCount + " of the " + nPhotosToSave + " photos that were selected.";
					titlePhotoStr = "Photos";
				}
				
				var retVal = PanelManager.CustomMessageBox("Unable to save " + errPhotoStr, "Save  " + titlePhotoStr, "Continue", 1,"");
				history.go(-1);
		    }
  		}
	}
	catch (ex)
	{
		TVShell.Message( "SaveNextPhoto():" +ex+ " " + ex.description );
		CleanupAbortedSave(false);
		return;
	}
}

function CancelSave()
{
	ActionCanceled=true;
	CleanupAbortedSave(true);
}

function AddVisuals()
{
   var rows=PhotoFolderOrganizer.GetObjectArray("FolderRow");
   if(!rows || !rows[0])
       return;
   var count=rows.length;
   for(i=0;i<count;i++)
       AddThumbnail(i);
   delete rows;
   rows=null;
}


function AddSlideShow(index)
{
   var rows=PhotoFolderOrganizer.GetObjectArray("FolderRow");

   if(!rows || !rows[0])
       return;
   var hrefNodeText=PhotoFolderOrganizer.GetFolderHREFS()[index];
   switch(g_StorageType)
   {
	  case LOCAL:
	  case ONLINE:
		var SS=rows[index].all.SlideshowHTC
	    if(SS)
			break;
		g_SlideshowHTC.imageFolderPath=hrefNodeText;
		g_SlideshowHTC.resizeImage = (g_StorageType != LOCAL);
		g_SlideshowHTC.imageStorageDevice = StorageDevice;
		g_SlideshowHTC.open();
		g_SlideshowHTC.play();
        g_SlideshowHTC.style.display="block";
		g_SlideshowHTC=rows[index].all.ThumbnailDiv.appendChild(g_SlideshowHTC);
		break;
	  default:
		break; 
   }

   delete rows;
   rows=null;
}

function RemoveSlideShow(index)
{

   var rows=PhotoFolderOrganizer.GetObjectArray("FolderRow");

   if(!rows || !rows[0])
       return;
   switch(g_StorageType)
   {
	  case LOCAL:
	  case ONLINE:
	    var SS=rows[index].all.SlideshowHTC
	    if(SS)
		{
		  g_SlideshowHTC.style.display="none";
		  SS.pause();
		  SS.close();
		  g_SlideshowHTC=rows[index].all.ThumbnailDiv.removeChild(SS)
		}

		break;
	  default:
		break; 
   }
   delete rows;
   rows=null;
}

var SupportedPhotoMIMETypes = "image/jpeg, image/gif, image/bmp, image/png";

function GetFirstPhotoInAlbum(StorageDevice, AlbumPath)
{
  
}


function AddThumbnail(index)
{

   var folderRows=PhotoFolderOrganizer.GetObjectArray("FolderRow");

   if(!folderRows || folderRows.length==0 || !folderRows[0])
       return;

   var firstItem=FirstItems[index]
   
   if(!firstItem)
   {  
      firstItem=PhotoFolderOrganizer.GetFirstFiles()[index];
	  FirstItems[index]=firstItem
   }
   
   if(firstItem && firstItem.length==3)
   {   	
		defaultThumb= PhotoManager.DefaultPhotoThumbURL;
		availableThumb=RequestThumbnail(firstItem[2]); 
		ThumbnailIndexMap[firstItem[2]]=index;
		folderRows[index].all.ThumbnailDiv.innerHTML="<table cellpadding=0 cellspacing=0 id=ThumbnailTable width=100% height=100%><tr><td align=center valign=center><img border=0 id=imgThumbnail"+index+" width=60 height=45 SRC='"+availableThumb+"' LOWSRC='"+defaultThumb+"'></td></tr></table>";
		folderRows[index].all["imgThumbnail"+index].onload=OnLoadThumbnail;
		delete firstItem;
		firstItem=null;
   }
   else
   		folderRows[index].all.ThumbnailDiv.innerHTML="<table cellpadding=0 cellspacing=0 id=ThumbnailTable width=100% height=100%><tr><td align=center valign=center><span id=noimagespan>No images</span></td></tr></table>";
   
}

function RemoveThumbnail(index)
{  

   var folderRows=PhotoFolderOrganizer.GetObjectArray("FolderRow");


   if(!folderRows || folderRows.length==0 || !folderRows[0])
       return;
   if(folderRows[index].all["imgThumbnail"+index])
   {  
      folderRows[index].all["imgThumbnail"+index].onload=null;
	  folderRows[index].all["imgThumbnail"+index].src="";
   }
   
   if(folderRows[index].all.ThumbnailDiv.firstChild && folderRows[index].all.ThumbnailDiv.firstChild.id=="ThumbnailTable")
     folderRows[index].all.ThumbnailDiv.innerHTML="";
   delete folderRows;
   folderRows=null;
     
}

function RequestThumbnail(fileName)
{
	var imgThumbURL=PhotoManager.DefaultPhotoThumbURL;
	
	if(IsInRotatedImageList(fileName))
	{
		var dstURL = PhotoManager.GetRotatedImageURL(fileName);
		imgThumbURL = PhotoManager.RequestThumbnail(dstURL, true, false);
	}
	else
	{	
		imgThumbURL = PhotoManager.RequestThumbnail(fileName,false, false);
	}

	return imgThumbURL;
}



function OnLoadThumbnail()
{
   
   var imgObj=event.srcElement;
   var url=imgObj.src

   url= url.substr(url.indexOf("file://")+7);
   //IE gives escaped url, we have unescape to pass it to thumbnail manager in case there are spaces in album name
   url=unescape(url);

   var originalImageWidth  = ThumbnailManager.GetImageWidth(url);
   var originalImageHeight = ThumbnailManager.GetImageHeight(url);

   if((originalImageHeight <= 45) && (originalImageWidth <= 60))
   {
      imgObj.width=originalImageWidth;
      imgObj.height=originalImageHeight;
   }
   var ratio=originalImageHeight/originalImageWidth;

   if(ratio>0.75)
   {
      imgObj.height=45;
      imgObj.width=parseInt(45/ratio);
   }
   else if(ratio<=0.75)
   {
      imgObj.width=60;
      imgObj.height=parseInt(60*ratio);
   }

}
function StopProgress()
{
   HideProgressPanel();
   history.go(-1);
}

function OnUnload()
{
	HideProgressPanel();
	CleanupXMLHTTPRequest();	
	delete g_SlideshowHTC;
	g_SlideshowHTC = null;
	Sink.DetachEvent(PhotoManager, "OnThumbnailReady"   , OnAlbumThumbnailReady);
	Sink.DetachEvent(PanelManager,"OnBeforeClose",OnBeforePreviewClose);
	Sink.DetachEvent( PhotoManager, "OnResizedImageReady",
	                  ResizeAndGetURL_OnResizedImageReady );
	PhotoFolderOrganizer.CleanUp();
	
	delete FirstItems;
	FirstItems = null;
	delete checkedList;
	checkedList = null;
	delete tempImage;
	tempImage=null;
	delete Sink;
	Sink=null;
	delete ThumbnailIndexMap;
	ThumbnailIndexMap=null;
}

function OnLoad()
{
	if ( TVShell.SystemInfo.AvailVirtualMemory < 3999999){
		TVShell.Message("Low Virtual Memory ("+TVShell.SystemInfo.AvailVirtualMemory +"). Prompting user to power off and then start the unit");
		TVShell.PanelManager.Item("main").Document.location.replace("msntv:/Shell/OutOfMemory.html");
	}
}

function Init()
{
	g_SlideshowHTC=mybody.removeChild(SlideshowHTC);
	SetProgressPercent(40);
	CreateContent();
	SetProgressPercent(90);
	HideProgressPanel();
}

</script>
</head >
<body id=mybody topmargin=0 leftmargin=0 rightmargin=0 bottommargin=0 onload="OnLoad()" onunload="OnUnload()">

	<table height=100% width=100% cellpadding=0 cellspacing=0>
	  <tr width=100%><td height=56>
	    <msntv:PhotoHeading id="Heading" label=""/>
      </td></tr>
	  <tr width=100% height=100% ><td width=100% height=100% valign=top>	  	
		<table width=100% height=100% cellpadding=0 cellspacing=0 >
		  <tr><td width=100% valign=top>
		    <msntv:FolderOrganizer id="PhotoFolderOrganizer" ItemName="photo" FileMimeType="image/jpeg, image/gif, image/bmp, image/png" MultiItemName="photos" />
		  </td></tr>
		</table>
      </td></tr>
      </table>
	  
	<msntv:slideShow id='SlideshowHTC' viewWidth='60' viewHeight='45' autoStart='false' autoAdvanceInterval='2'  initialLoadingText ="<font size=1>Loading</font>" maxSearchCount=5 style="display:none"/>
	  
	<script>
	  Init();
	</script>
</body>
</html>
